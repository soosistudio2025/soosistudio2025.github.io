<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="manifest" href="manifest-admin.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å®¿æ´— Admin">
    <link rel="apple-touch-icon" href="nav.png">
    <link rel="icon" type="image/png" href="nav.png">
    <meta name="theme-color" content="#6A8D73">
<title>å®¿æ´— Soosi | å¾Œå°ç®¡ç†ç³»çµ±</title>    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        soosi: {
                            green: '#6A8D73',      // ä¸»è‰²ï¼šç¶ è‰²
                            wood: '#8E6E53',       // å‰¯è‰²ï¼šæœ¨é ­è‰²
                            dark: '#3F3F3F',       // æ–‡å­—ï¼šæ·±ç°
                            light: '#F9F7F2',      // èƒŒæ™¯ï¼šç±³ç™½
                            accent: '#E6C66D',     // é»ç¶´ï¼šé‡‘é»ƒ
                            red: '#D67D7D'         // è­¦ç¤ºï¼šæŸ”å’Œç´…
                        }
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', '"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        :root { --brand-bg: #F9F7F2; }
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--brand-bg);
            color: #3F3F3F;
            -webkit-font-smoothing: antialiased;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(106, 141, 115, 0.1);
            border-radius: 2rem;
        }

        .cute-card {
            background: #FFFDF9;
            border: 2px solid #F0ECE6;
            border-radius: 1.5rem;
            box-shadow: 3px 3px 0px 0px rgba(142, 110, 83, 0.05);
            transition: all 0.2s;
        }
        .cute-card:hover { transform: translateY(-2px); box-shadow: 4px 4px 0px 0px rgba(106, 141, 115, 0.1); border-color: #6A8D73; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 900; }
        .status-pending { background: #FEF3C7; color: #D97706; }
        .status-confirmed { background: #D1FAE5; color: #059669; }
        .status-completed { background: #E5E7EB; color: #374151; }
        .status-cancelled { background: #FEE2E2; color: #DC2626; }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ (ç·¨è¼¯æ¨¡å¼ç”¨) */
        .admin-input {
            width: 100%;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 14px;
            color: #333;
        }
        .admin-input:focus { outline: none; border-color: #6A8D73; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Supabase Config ---
        const supabaseUrl = 'https://uhrngtsashumvwgzaumm.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocm5ndHNhc2h1bXZ3Z3phdW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMjMxNDUsImV4cCI6MjA4NDg5OTE0NX0.YDopNd9MHsjV9LFsHWyrxFIcWgQ_s0BMJlNSFqQfiTE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const ADMIN_EMAIL = "soosi.studio2025@gmail.com";
        const STAFF_EMAIL = "staff@soosi.com";
        const ADMIN_PWD = "soosi"; // ğŸ”’ ç°¡æ˜“å‰ç«¯é©—è­‰å¯†ç¢¼

        const Icon = ({ name, size = 18, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({ root: iconRef.current, attrs: { "stroke-width": 2.5, class: className } });
                }
            }, [name, className]);
            return <span ref={iconRef} key={name} className="inline-flex items-center justify-center"><i data-lucide={name} style={{ width: size, height: size }}></i></span>;
        };

        // --- ç¿»è­¯èˆ‡æ ¼å¼åŒ–å·¥å…· ---
        const T = (key) => {
            if (key === true || key === 'true') return 'æ˜¯';
            if (key === false || key === 'false') return 'å¦';
            if (!key) return '-';
            
            const map = {
                'basic': 'å°ç¾å®¹', 'full': 'å¤§ç¾å®¹',
                'dog': 'ç‹—ç‹—', 'cat': 'è²“å’ª',
                'grooming': 'ç¾å®¹', 'boarding': 'ä½å®¿', 'daycare': 'å®‰è¦ª',
                'local_style': 'å±€éƒ¨ä¿®é£¾', 'special_style': 'ç‰¹æ®Šé€ å‹', 'scissor_cut': 'å…¨èº«æ‰‹å‰ª',
                'local_degrease': 'å±€éƒ¨å»æ²¹', 'full_degrease': 'å…¨èº«å»æ²¹',
                'spa_dental': 'å£è…”å‡è† ', 'spa_oil': 'æ½”è†šæ²¹', 'spa_ear': 'æ—¥æœ¬æ¡è€³',
                'spa_carbon': 'ç¢³é…¸æµ´', 'spa_bath': 'èˆ’æ•æµ´', 'spa_nano': 'å¥ˆç±³æµ´',
                'spa_salt': 'æµ·é¹½æµ´', 'spa_mud_exfoliate': 'å»è§’è³ªæ³¥', 'spa_bubble': 'æ³¡æ³¡æµ´', 'spa_volcano': 'ç«å±±æ³¥',
                'spa_ceramide_local': 'å±€éƒ¨ä¿æ¿•', 'spa_ceramide_full': 'å…¨èº«ä¿æ¿•',
                'other': 'å…¶ä»–é …ç›®'
            };
            return map[key] || key;
        };

        // --- æ¬Šé™é©—è­‰ Modal ---
        const SecurityModal = ({ isOpen, onClose, onConfirm, title = "æ¬Šé™é©—è­‰" }) => {
            const [pwd, setPwd] = useState("");
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl animate-in zoom-in-95">
                        <h3 className="font-black text-lg text-center mb-4">{title}</h3>
                        <input type="password" autoFocus placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" 
                            className="w-full border-2 border-gray-200 rounded-xl p-3 text-center mb-4 outline-none focus:border-soosi-wood"
                            value={pwd} onChange={e=>setPwd(e.target.value)}
                        />
                        <div className="flex gap-2">
                            <button onClick={onClose} className="flex-1 py-2 bg-gray-100 rounded-lg text-xs font-bold text-gray-500">å–æ¶ˆ</button>
                            <button onClick={()=>{
                                if(pwd === ADMIN_PWD) { onConfirm(); onClose(); setPwd(""); } 
                                else alert("å¯†ç¢¼éŒ¯èª¤");
                            }} className="flex-1 py-2 bg-soosi-wood text-white rounded-lg text-xs font-bold">ç¢ºèª</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ç™»å…¥ View ---
        const LoginView = ({ onLogin }) => {
            const [loginEmail, setLoginEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const { data, error: authError } = await supabase.auth.signInWithPassword({ email: loginEmail, password });
                if (authError) {
                    setError('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
                    setLoading(false);
                } else {
                    onLogin();
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 relative overflow-hidden">
                    <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-soosi-green/20 rounded-full blur-3xl"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-80 h-80 bg-soosi-wood/10 rounded-full blur-3xl"></div>
                    
                    <div className="glass-card w-full max-w-md p-10 text-center relative z-10 animate-in zoom-in duration-500">
                        <img src="nav.png" className="w-40 mx-auto mb-6 drop-shadow-sm" alt="Soosi Logo" />
                        
                        {!loginEmail ? (
                            <div className="space-y-4">
                                <h1 className="text-xl font-black text-soosi-dark mb-6">å®¿æ´— Soosi | ç®¡ç†å¾Œå°</h1>
                                <button onClick={() => setLoginEmail(ADMIN_EMAIL)} className="w-full bg-white border-2 border-soosi-green/20 hover:border-soosi-green hover:bg-soosi-green/5 text-soosi-dark py-4 rounded-2xl font-black flex items-center justify-center gap-3 transition-all active:scale-95">
                                    <div className="w-10 h-10 rounded-full bg-soosi-green text-white flex items-center justify-center"><Icon name="shield" /></div>
                                    ç®¡ç†å“¡ç™»å…¥
                                </button>
                                <button onClick={() => setLoginEmail(STAFF_EMAIL)} className="w-full bg-white border-2 border-soosi-wood/20 hover:border-soosi-wood hover:bg-soosi-wood/5 text-soosi-dark py-4 rounded-2xl font-black flex items-center justify-center gap-3 transition-all active:scale-95">
                                    <div className="w-10 h-10 rounded-full bg-soosi-wood text-white flex items-center justify-center"><Icon name="user" /></div>
                                    å“¡å·¥ç™»å…¥
                                </button>
                            </div>
                        ) : (
                            <form onSubmit={handleLogin} className="space-y-4 animate-in fade-in slide-in-from-bottom-2">
                                <div className="text-center mb-4">
                                    <span className={`px-4 py-1 rounded-full text-xs font-black text-white ${loginEmail === ADMIN_EMAIL ? 'bg-soosi-green' : 'bg-soosi-wood'}`}>
                                        {loginEmail === ADMIN_EMAIL ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬å“¡å·¥'}
                                    </span>
                                    <p className="text-sm font-bold text-soosi-dark/60 mt-2">{loginEmail}</p>
                                </div>
                                <input type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" value={password} onChange={e=>setPassword(e.target.value)} className="w-full text-center py-4 rounded-2xl border-2 border-soosi-green/20 focus:border-soosi-green outline-none font-black text-lg tracking-widest" autoFocus />
                                {error && <p className="text-soosi-red text-xs font-black">{error}</p>}
                                <button disabled={loading} className="w-full bg-soosi-dark text-white py-4 rounded-2xl font-black text-lg shadow-lg hover:opacity-90 transition-all flex items-center justify-center gap-2">
                                    {loading ? <Icon name="loader-2" className="animate-spin" /> : 'ç¢ºèªç™»å…¥'}
                                </button>
                                <button type="button" onClick={() => setLoginEmail('')} className="text-xs font-bold text-gray-400 hover:text-soosi-dark transition-colors">â† åˆ‡æ›èº«åˆ†</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        // --- è¨‚å–®è©³æƒ… Modal (å«ç·¨è¼¯èˆ‡å®Œæ•´è³‡è¨Š) ---
        const OrderModal = ({ order, onClose, onUpdateStatus, onUpdateNote, onDeleteOrder, onUpdateFullOrder }) => {
            if (!order) return null;
            const [localNote, setLocalNote] = useState(order.admin_note || '');
            const [isEditing, setIsEditing] = useState(false);
            const [showAuth, setShowAuth] = useState(false); // æ§åˆ¶ç·¨è¼¯æ¬Šé™ Modal
            const [showDeleteAuth, setShowDeleteAuth] = useState(false); // æ§åˆ¶åˆªé™¤æ¬Šé™ Modal
            const [editData, setEditData] = useState(JSON.parse(JSON.stringify(order))); // Deep copy for editing

            const isBoarding = order.service_type === 'boarding' || order.service_type === 'daycare';
            
            // è™•ç†å‚™è¨»æ›´æ–° (å¤±ç„¦å³å„²å­˜)
            const handleNoteBlur = () => {
                if (localNote !== order.admin_note) {
                    onUpdateNote(order.id, localNote);
                }
            };

            // è™•ç†ç·¨è¼¯æ¬„ä½è®Šæ›´
            const handleEditChange = (path, value) => {
                setEditData(prev => {
                    const newData = { ...prev };
                    // ç°¡å–®è™•ç†ç¬¬ä¸€å±¤ (owner info)
                    if (path.startsWith('owner_')) newData[path] = value;
                    else if (path === 'phone' || path === 'email' || path === 'total_price') newData[path] = value;
                    else if (path.startsWith('raw_data.')) {
                        // è™•ç† raw_data å…§å±¤ (address, emergency etc)
                        const key = path.split('.')[1];
                        if (!newData.raw_data) newData.raw_data = {};
                        if (!newData.raw_data.raw_data) newData.raw_data.raw_data = {}; // ç¢ºä¿çµæ§‹
                        newData.raw_data.raw_data[key] = value;
                    }
                    return newData;
                });
            };

            // è™•ç†å¯µç‰©æ¬„ä½è®Šæ›´
            const handlePetChange = (petIdx, field, value) => {
                setEditData(prev => {
                    const newData = { ...prev };
                    const newPets = [...newData.booking_pets];
                    newPets[petIdx] = { ...newPets[petIdx], [field]: value };
                    newData.booking_pets = newPets;
                    return newData;
                });
            };

            const saveChanges = () => {
                onUpdateFullOrder(editData);
                setIsEditing(false);
            };

            // æ¸²æŸ“æ¬„ä½ Helper (View/Edit æ¨¡å¼åˆ‡æ›)
            const RenderField = ({ label, value, editPath, type = 'text' }) => (
                <div className="mb-2">
                    <label className="text-[10px] font-bold text-gray-400 block mb-0.5">{label}</label>
                    {isEditing ? (
                        <input 
                            type={type} 
                            value={value || ''} 
                            onChange={(e) => handleEditChange(editPath, e.target.value)}
                            className="admin-input"
                        />
                    ) : (
                        <div className="font-bold text-soosi-dark text-sm break-words">{T(value)}</div>
                    )}
                </div>
            );

            // è®€å– raw_data çš„å®‰å…¨æ–¹æ³•
            const getRaw = (key) => editData.raw_data?.raw_data?.[key] || editData.raw_data?.[key] || '';

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-soosi-dark/60 backdrop-blur-sm animate-in fade-in">
                    <div className="w-full max-w-4xl bg-[#F9F7F2] rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
                        {/* Header */}
                        <div className="bg-white px-8 py-5 flex justify-between items-center border-b border-gray-100 shrink-0">
                            <div>
                                <h3 className="font-black text-xl text-soosi-dark flex items-center gap-2">
                                    {isBoarding ? <Icon name="home" className="text-soosi-wood"/> : <Icon name="scissors" className="text-soosi-green"/>}
                                    {isBoarding ? (order.service_type === 'daycare' ? 'å®‰è¦ªè©³æƒ…' : 'ä½å®¿è©³æƒ…') : 'ç¾å®¹è©³æƒ…'}
                                    {isEditing && <span className="text-xs bg-red-100 text-red-500 px-2 py-1 rounded ml-2">ç·¨è¼¯æ¨¡å¼</span>}
                                </h3>
                                <p className="text-[10px] text-gray-400 font-bold tracking-widest uppercase">ID: {order.id.slice(0,8)}</p>
                            </div>
                            <div className="flex gap-2">
                                {!isEditing ? (
                                    <>
                                        <button onClick={() => setShowAuth(true)} className="p-2 bg-gray-100 hover:bg-soosi-wood hover:text-white rounded-full transition-colors" title="ç·¨è¼¯è³‡æ–™">
                                            <Icon name="edit-2" size={18}/>
                                        </button>
                                        <button onClick={() => setShowDeleteAuth(true)} className="p-2 bg-red-50 hover:bg-red-500 hover:text-white text-red-400 rounded-full transition-colors" title="åˆªé™¤è¨‚å–®">
                                            <Icon name="trash-2" size={18}/>
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button onClick={() => setIsEditing(false)} className="px-4 py-2 bg-gray-200 rounded-xl text-xs font-bold">å–æ¶ˆ</button>
                                        <button onClick={saveChanges} className="px-4 py-2 bg-soosi-green text-white rounded-xl text-xs font-bold shadow-md">å„²å­˜è®Šæ›´</button>
                                    </>
                                )}
                                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors ml-2"><Icon name="x" size={24}/></button>
                            </div>
                        </div>

                        <div className="p-8 overflow-y-auto space-y-6">
                            {/* 1. ç‹€æ…‹èˆ‡åº—å®¶å‚™è¨» (æ‰€æœ‰äººå¯ç·¨è¼¯) */}
                            <div className="grid md:grid-cols-2 gap-4">
                                <div className="bg-white p-5 rounded-3xl border border-soosi-green/10 shadow-sm">
                                    <label className="text-xs font-bold text-gray-400 mb-2 block">è¨‚å–®ç‹€æ…‹</label>
                                    <div className="flex flex-wrap gap-2">
                                        {['pending', 'confirmed', 'completed', 'cancelled'].map(status => (
                                            <button key={status} 
                                                onClick={()=>onUpdateStatus(order.id, status)} 
                                                className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${
                                                    order.status === status 
                                                    ? 'bg-soosi-green text-white border-soosi-green' 
                                                    : 'bg-white text-gray-400 border-gray-200 hover:border-soosi-green'
                                                }`}
                                            >
                                                {status === 'pending' ? 'å¾…ç¢ºèª' : status === 'confirmed' ? 'å·²ç¢ºèª' : status === 'completed' ? 'å·²å®Œæˆ' : 'å·²å–æ¶ˆ'}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="bg-white p-5 rounded-3xl border border-soosi-wood/10 shadow-sm relative group">
                                    <label className="text-xs font-bold text-soosi-wood mb-1 flex items-center gap-1">
                                        <Icon name="sticky-note" size={14}/> åº—å®¶å‚™è¨» (å…§éƒ¨ç”¨)
                                    </label>
                                    <textarea 
                                        className="w-full h-20 bg-yellow-50/50 p-2 rounded-xl text-sm border border-transparent focus:border-soosi-wood outline-none resize-none"
                                        placeholder="åœ¨æ­¤è¼¸å…¥å‚™è¨»äº‹é …..."
                                        value={localNote}
                                        onChange={(e)=>setLocalNote(e.target.value)}
                                        onBlur={handleNoteBlur}
                                    />
                                    <div className="absolute bottom-2 right-2 text-[10px] text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity">è‡ªå‹•å„²å­˜</div>
                                </div>
                            </div>

                            {/* 2. å®Œæ•´é£¼ä¸»è³‡è¨Š */}
                            <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100">
                                <h4 className="font-black text-soosi-dark mb-4 flex items-center gap-2 border-b border-dashed pb-2">
                                    <Icon name="user" size={18}/> é£¼ä¸»è©³ç´°è³‡æ–™
                                </h4>
                                <div className="grid md:grid-cols-3 gap-6">
                                    <RenderField label="å§“å" value={editData.owner_name} editPath="owner_name" />
                                    <RenderField label="é›»è©±" value={editData.phone} editPath="phone" />
                                    <RenderField label="Email" value={editData.email} editPath="email" />
                                    <RenderField label="èº«åˆ†è­‰å­—è™Ÿ" value={getRaw('owner_id')} editPath="raw_data.owner_id" />
                                    <div className="md:col-span-2">
                                        <RenderField label="åœ°å€" value={getRaw('address')} editPath="raw_data.address" />
                                    </div>
                                    <RenderField label="ç·Šæ€¥è¯çµ¡äºº" value={getRaw('emergency_name')} editPath="raw_data.emergency_name" />
                                    <RenderField label="ç·Šæ€¥é›»è©±" value={getRaw('emergency_phone')} editPath="raw_data.emergency_phone" />
                                    <div className="md:col-span-1">
                                        <RenderField label="ç¸½é‡‘é¡" value={editData.total_price} editPath="total_price" type="number" />
                                    </div>
                                </div>
                            </div>

                            {/* 3. å®Œæ•´å¯µç‰©åˆ—è¡¨ */}
                            <div>
                                <h4 className="font-black text-soosi-dark mb-4 flex items-center gap-2 ml-1">
                                    <Icon name="paw-print" size={20} className="text-soosi-wood"/> 
                                    å¯µç‰©è©³ç´°è³‡æ–™ ({editData.booking_pets?.length || 0} éš»)
                                </h4>
                                <div className="space-y-4">
                                    {editData.booking_pets?.map((pet, idx) => (
                                        <div key={idx} className="bg-white p-6 rounded-[2rem] border-2 border-soosi-green/10 shadow-sm relative">
                                            <div className="absolute top-4 right-4 text-[10px] text-gray-300 font-bold">#{idx + 1}</div>
                                            
                                            {/* åŸºæœ¬è³‡æ–™ */}
                                            <div className="grid md:grid-cols-4 gap-4 mb-4 border-b border-dashed pb-4">
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-400">åå­—</label>
                                                    {isEditing ? (
                                                        <input value={pet.pet_name} onChange={e=>handlePetChange(idx, 'pet_name', e.target.value)} className="admin-input font-bold text-soosi-dark"/>
                                                    ) : <div className="text-lg font-black text-soosi-dark">{pet.pet_name}</div>}
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-400">å“ç¨®</label>
                                                    {isEditing ? (
                                                        <input value={pet.breed} onChange={e=>handlePetChange(idx, 'breed', e.target.value)} className="admin-input"/>
                                                    ) : <div className="font-bold">{pet.breed}</div>}
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-400">åŸºæœ¬è³‡è¨Š</label>
                                                    {isEditing ? (
                                                        <div className="flex gap-1">
                                                            <input value={pet.sex} onChange={e=>handlePetChange(idx, 'sex', e.target.value)} className="admin-input w-1/3" placeholder="æ€§åˆ¥"/>
                                                            <input value={pet.age} onChange={e=>handlePetChange(idx, 'age', e.target.value)} className="admin-input w-1/3" placeholder="æ­²"/>
                                                            <input value={pet.weight} onChange={e=>handlePetChange(idx, 'weight', e.target.value)} className="admin-input w-1/3" placeholder="kg"/>
                                                        </div>
                                                    ) : <div className="font-bold">{pet.sex} / {pet.age}æ­² / {pet.weight}kg</div>}
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-400">çµç´® / æ™¶ç‰‡</label>
                                                    <div className="font-bold">{T(pet.fix)} / {T(getRaw('chip_status'))}</div>
                                                </div>
                                            </div>

                                            {/* è©³ç´°å•å· (å”¯è®€æˆ–ç·¨è¼¯éœ€æ›´è¤‡é›œçµæ§‹ï¼Œé€™è£¡å±•ç¤ºå…¨éƒ¨è³‡è¨Š) */}
                                            <div className="grid md:grid-cols-2 gap-x-8 gap-y-3 text-sm">
                                                <div className="space-y-2">
                                                    <div className="flex justify-between border-b border-gray-50 pb-1"><span className="text-gray-400 text-xs">å€‹æ€§/åˆ†é›¢ç„¦æ…®</span><span className="font-bold text-right">{pet.personality || '-'}</span></div>
                                                    <div className="flex justify-between border-b border-gray-50 pb-1"><span className="text-gray-400 text-xs">ç‰¹æ®Šæ³¨æ„äº‹é …</span><span className="font-bold text-right text-soosi-red">{getRaw('specialNotes') || 'ç„¡'}</span></div>
                                                    <div className="flex justify-between border-b border-gray-50 pb-1"><span className="text-gray-400 text-xs">ç¾å®¹æ€§æƒ…</span><span className="font-bold text-right">{getRaw('grooming_temperament')}</span></div>
                                                    <div className="flex justify-between border-b border-gray-50 pb-1"><span className="text-gray-400 text-xs">ç¤¾äº¤/æ”»æ“Šæ€§</span><span className="font-bold text-right">{getRaw('social_aggression')} / {getRaw('social_play')}</span></div>
                                                </div>
                                                <div className="space-y-2">
                                                    <div className="flex justify-between border-b border-gray-50 pb-1"><span className="text-gray-400 text-xs">éå¾€ç—…å²</span><span className="font-bold text-right text-soosi-red">{pet.medical_status === 'æœ‰' ? (pet.medical_history||[]).join(',') : 'ç„¡'}</span></div>
                                                    <div className="flex justify-between border-b border-gray-50 pb-1"><span className="text-gray-400 text-xs">ç–«è‹—/é©…èŸ²</span><span className="font-bold text-right">{getRaw('vaccine')} / {getRaw('deworm')}</span></div>
                                                    <div className="flex justify-between border-b border-gray-50 pb-1"><span className="text-gray-400 text-xs">é£²é£Ÿç¿’æ…£</span><span className="font-bold text-right">{(getRaw('diet_type')||[]).join(',')}</span></div>
                                                    <div className="flex justify-between border-b border-gray-50 pb-1"><span className="text-gray-400 text-xs">å…¶ä»–ç¿’æ…£</span><span className="font-bold text-right text-[10px]">
                                                        {getRaw('isBarking') === 'æœƒ' && ' æœƒå«'} 
                                                        {getRaw('isFoodGuarding') === 'æœƒ' && ' è­·é£Ÿ'}
                                                        {getRaw('useToiletPad') === 'æœƒ' && ' å°¿å¸ƒå¢Š'}
                                                    </span></div>
                                                </div>
                                            </div>

                                            {/* æœå‹™å…§å®¹ */}
                                            {pet.add_grooming && (
                                                <div className="mt-4 bg-soosi-green/5 p-3 rounded-xl">
                                                    <div className="font-black text-soosi-green text-xs mb-2">åŠ è³¼ç¾å®¹é …ç›® (${pet.grooming_price})</div>
                                                    <div className="flex flex-wrap gap-1.5">
                                                        {pet.service_items?.map((item, i) => (
                                                            <span key={i} className="text-[10px] bg-white text-soosi-green px-2.5 py-1 rounded-full font-black border border-soosi-green/10 shadow-sm">{T(item)}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* ç°½å */}
                            {order.signature_url && (
                                <div className="text-center pt-4 border-t border-dashed border-gray-200">
                                    <label className="text-[10px] font-black text-gray-400 block mb-3 uppercase tracking-widest">å®¢æˆ¶ç°½å (Customer Signature)</label>
                                    <img src={order.signature_url} className="h-24 mx-auto opacity-80 mix-blend-multiply" />
                                </div>
                            )}
                        </div>
                    </div>

                    {/* æ¬Šé™é©—è­‰ Modal */}
                    <SecurityModal 
                        isOpen={showAuth} 
                        onClose={()=>setShowAuth(false)} 
                        onConfirm={()=>setIsEditing(true)} 
                        title="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ä»¥ç·¨è¼¯"
                    />
                    <SecurityModal 
                        isOpen={showDeleteAuth} 
                        onClose={()=>setShowDeleteAuth(false)} 
                        onConfirm={()=>onDeleteOrder(order.id)} 
                        title="âš ï¸ å±éšªæ“ä½œï¼šåˆªé™¤è¨‚å–®"
                    />
                </div>
            );
        };

        // --- ä¸» Dashboard ---
        const Dashboard = () => {
            const [activeTab, setActiveTab] = useState('grooming'); // grooming | boarding
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            // è®€å–è¨‚å–®
            const fetchOrders = async () => {
                setLoading(true);
                const filterTypes = activeTab === 'grooming' ? ['grooming'] : ['boarding', 'daycare'];
                const { data, error } = await supabase
                    .from('bookings')
                    .select('*, booking_pets(*)')
                    .in('service_type', filterTypes)
                    .order('created_at', { ascending: false });
                
                if (!error) setOrders(data || []);
                setLoading(false);
            };

            // æ›´æ–°ç‹€æ…‹
            const updateStatus = async (id, newStatus) => {
                const { error } = await supabase.from('bookings').update({ status: newStatus }).eq('id', id);
                if (!error) {
                    setOrders(prev => prev.map(o => o.id === id ? { ...o, status: newStatus } : o));
                    if (selectedOrder?.id === id) setSelectedOrder(prev => ({ ...prev, status: newStatus }));
                }
            };

            // æ›´æ–°å‚™è¨»
            const updateNote = async (id, note) => {
                const { error } = await supabase.from('bookings').update({ admin_note: note }).eq('id', id);
                if (!error) {
                    setOrders(prev => prev.map(o => o.id === id ? { ...o, admin_note: note } : o));
                }
            };

            // åˆªé™¤è¨‚å–®
            const deleteOrder = async (id) => {
                const { error } = await supabase.from('bookings').delete().eq('id', id);
                if (!error) {
                    setOrders(prev => prev.filter(o => o.id !== id));
                    setSelectedOrder(null);
                    alert("è¨‚å–®å·²åˆªé™¤");
                } else {
                    alert("åˆªé™¤å¤±æ•—");
                }
            };

            // å®Œæ•´æ›´æ–° (ç·¨è¼¯æ¨¡å¼)
            const updateFullOrder = async (updatedOrder) => {
                // 1. æ›´æ–°ä¸»è¡¨
                const { error: mainError } = await supabase.from('bookings').update({
                    owner_name: updatedOrder.owner_name,
                    phone: updatedOrder.phone,
                    email: updatedOrder.email,
                    total_price: updatedOrder.total_price,
                    raw_data: updatedOrder.raw_data // æ›´æ–° JSONB çµæ§‹
                }).eq('id', updatedOrder.id);

                // 2. æ›´æ–°å¯µç‰©è¡¨ (ç°¡åŒ–ï¼šé€ä¸€æ›´æ–°)
                if (!mainError && updatedOrder.booking_pets) {
                    for (const pet of updatedOrder.booking_pets) {
                        await supabase.from('booking_pets').update({
                            pet_name: pet.pet_name,
                            breed: pet.breed,
                            sex: pet.sex,
                            age: pet.age,
                            weight: pet.weight
                        }).eq('id', pet.id);
                    }
                }

                if (!mainError) {
                    setOrders(prev => prev.map(o => o.id === updatedOrder.id ? updatedOrder : o));
                    setSelectedOrder(updatedOrder); // æ›´æ–° Modal é¡¯ç¤º
                    alert("è³‡æ–™å·²æ›´æ–°ï¼");
                } else {
                    alert("æ›´æ–°å¤±æ•—ï¼š" + mainError.message);
                }
            };

            useEffect(() => { fetchOrders(); }, [activeTab]);

            const filteredOrders = useMemo(() => {
                return orders.filter(o => 
                    o.owner_name?.includes(searchTerm) || 
                    o.phone?.includes(searchTerm) || 
                    o.booking_pets?.some(p => p.pet_name?.includes(searchTerm))
                );
            }, [orders, searchTerm]);

            return (
                <div className="min-h-screen pb-20">
                    <nav className="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-soosi-green/10 px-6 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-3">
                            <img src="nav.png" className="w-10 h-10 object-contain" />
                            <span className="font-black text-soosi-dark text-xl tracking-tight">Soosi Admin</span>
                        </div>
                        <button onClick={() => supabase.auth.signOut()} className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-soosi-red transition-all"><Icon name="log-out"/></button>
                    </nav>

                    <main className="max-w-4xl mx-auto p-6 space-y-6">
                        {/* æœå°‹ */}
                        <div className="relative group">
                            <Icon name="search" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 group-focus-within:text-soosi-green transition-colors" />
                            <input 
                                type="text" 
                                placeholder="æœå°‹ä¸»äººå§“åã€é›»è©±ã€æ¯›å­©åå­—..." 
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="w-full pl-12 pr-4 py-4 rounded-2xl bg-white shadow-sm border-2 border-transparent focus:border-soosi-green outline-none font-bold text-sm transition-all"
                            />
                        </div>

                        {/* åˆ†é  Tab */}
                        <div className="flex bg-white p-1.5 rounded-[1.5rem] shadow-sm border border-gray-100">
                            <button onClick={() => setActiveTab('grooming')} className={`flex-1 py-3 rounded-2xl font-black text-sm flex items-center justify-center gap-2 transition-all ${activeTab === 'grooming' ? 'bg-soosi-green text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
                                <Icon name="scissors" size={16}/> æ´—æ¾¡ç¾å®¹
                            </button>
                            <button onClick={() => setActiveTab('boarding')} className={`flex-1 py-3 rounded-2xl font-black text-sm flex items-center justify-center gap-2 transition-all ${activeTab === 'boarding' ? 'bg-soosi-wood text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
                                <Icon name="home" size={16}/> ä½å®¿å®‰è¦ª
                            </button>
                        </div>

                        {/* è¨‚å–®åˆ—è¡¨ */}
                        {loading ? (
                            <div className="py-20 text-center text-gray-400 font-black animate-pulse">è¼‰å…¥è³‡æ–™ä¸­...</div>
                        ) : (
                            <div className="space-y-4">
                                {filteredOrders.map(order => (
                                    <div key={order.id} onClick={() => setSelectedOrder(order)} className="cute-card p-6 bg-white cursor-pointer relative overflow-hidden group">
                                        <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${
                                            order.status === 'confirmed' ? 'bg-soosi-green' : 
                                            order.status === 'pending' ? 'bg-soosi-accent' : 
                                            order.status === 'cancelled' ? 'bg-soosi-red' : 'bg-gray-200'
                                        }`}></div>
                                        
                                        <div className="flex justify-between items-start mb-3">
                                            <div>
                                                <div className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">
                                                    {T(order.service_type)} 
                                                    Â· {new Date(order.created_at).toLocaleDateString()}
                                                </div>
                                                <div className="font-black text-xl text-soosi-dark flex items-center gap-2">
                                                    {order.owner_name}
                                                    {order.booking_pets?.length > 1 && <span className="text-[10px] bg-soosi-wood/10 text-soosi-wood px-2 py-0.5 rounded-full">{order.booking_pets.length}éš»æ¯›å­©</span>}
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-black text-lg text-soosi-wood">${order.total_price}</div>
                                                <span className={`status-badge block mt-1 ${
                                                    order.status === 'pending' ? 'status-pending' :
                                                    order.status === 'confirmed' ? 'status-confirmed' :
                                                    order.status === 'cancelled' ? 'status-cancelled' : 'status-completed'
                                                }`}>
                                                    {order.status === 'pending' ? 'å¾…ç¢ºèª' :
                                                     order.status === 'confirmed' ? 'å·²ç¢ºèª' :
                                                     order.status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'å·²å®Œæˆ'}
                                                </span>
                                            </div>
                                        </div>

                                        <div className="flex items-center gap-4 text-xs font-black text-gray-400">
                                            <div className="flex items-center gap-1.5 text-soosi-green">
                                                <Icon name="paw-print" size={14}/>
                                                {order.booking_pets?.slice(0, 2).map(p => p.pet_name).join(', ')}
                                                {order.booking_pets?.length > 2 && '...'}
                                            </div>
                                            <div className="flex items-center gap-1.5">
                                                <Icon name="calendar" size={14}/>
                                                {order.check_in_date || order.booking_date}
                                            </div>
                                        </div>
                                        {/* åˆ—è¡¨é¡¯ç¤ºå‚™è¨»é è¦½ */}
                                        {order.admin_note && (
                                            <div className="mt-3 pt-3 border-t border-dashed text-xs text-soosi-wood/80 truncate">
                                                <span className="font-bold">ğŸ“ å‚™è¨»ï¼š</span>{order.admin_note}
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {filteredOrders.length === 0 && <div className="py-20 text-center text-gray-300 font-black">æš«ç„¡ç›¸é—œé ç´„è¨‚å–® ğŸƒ</div>}
                            </div>
                        )}
                    </main>

                    <OrderModal 
                        order={selectedOrder} 
                        onClose={() => setSelectedOrder(null)} 
                        onUpdateStatus={updateStatus} 
                        onUpdateNote={updateNote}
                        onDeleteOrder={deleteOrder}
                        onUpdateFullOrder={updateFullOrder}
                    />
                </div>
            );
        };

        const App = () => {
            const [session, setSession] = useState(null);
            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => setSession(session));
                supabase.auth.onAuthStateChange((_event, session) => setSession(session));
            }, []);
            return session ? <Dashboard /> : <LoginView onLogin={() => {}} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
    <script>
        // Admin Service Worker è‡ªå‹•æ›´æ–°è…³æœ¬
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    // è¨»å†Š sw-admin.js
                    const registration = await navigator.serviceWorker.register('./sw-admin.js?v=3');
                    console.log('Admin Service Worker è¨»å†ŠæˆåŠŸ');

                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('ç®¡ç†å¾Œå°åµæ¸¬åˆ°æ–°ç‰ˆæœ¬ï¼Œè‡ªå‹•æ›´æ–°ä¸­...');
                                window.location.reload();
                            }
                        });
                    });
                } catch (error) {
                    console.error('Admin Service Worker è¨»å†Šå¤±æ•—:', error);
                }
            });
        }
    </script>
</body>
</html>
