<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest-admin.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å®¿æ´— Admin">
    <link rel="apple-touch-icon" href="nav.png">
    <link rel="icon" type="image/png" href="nav.png">
    <meta name="theme-color" content="#6A8D73">
    <title>å®¿æ´— Soosi | å¾Œå°ç®¡ç†ç³»çµ±</title>    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        soosi: {
                            green: '#6A8D73',      // ä¸»è‰²ï¼šç¶ è‰²
                            wood: '#8E6E53',       // å‰¯è‰²ï¼šæœ¨é ­è‰²
                            dark: '#3F3F3F',       // æ–‡å­—ï¼šæ·±ç°
                            light: '#F9F7F2',      // èƒŒæ™¯ï¼šç±³ç™½
                            accent: '#E6C66D',     // é»ç¶´ï¼šé‡‘é»ƒ
                            red: '#D67D7D'         // è­¦ç¤ºï¼šæŸ”å’Œç´…
                        }
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', '"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        :root { --brand-bg: #F9F7F2; }
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--brand-bg);
            color: #3F3F3F;
            -webkit-font-smoothing: antialiased;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(106, 141, 115, 0.1);
            border-radius: 2rem;
        }

        .cute-card {
            background: #FFFDF9;
            border: 2px solid #F0ECE6;
            border-radius: 1.5rem;
            box-shadow: 3px 3px 0px 0px rgba(142, 110, 83, 0.05);
            transition: all 0.2s;
        }
        .cute-card:hover { transform: translateY(-2px); box-shadow: 4px 4px 0px 0px rgba(106, 141, 115, 0.1); border-color: #6A8D73; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 900; }
        .status-pending { background: #FEF3C7; color: #D97706; }
        .status-confirmed { background: #D1FAE5; color: #059669; }
        .status-completed { background: #E5E7EB; color: #374151; }
        .status-cancelled { background: #FEE2E2; color: #DC2626; }
        
        .admin-input {
            width: 100%;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 14px;
            color: #333;
        }
        .admin-input:focus { outline: none; border-color: #6A8D73; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Supabase Config ---
        const supabaseUrl = 'https://uhrngtsashumvwgzaumm.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocm5ndHNhc2h1bXZ3Z3phdW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMjMxNDUsImV4cCI6MjA4NDg5OTE0NX0.YDopNd9MHsjV9LFsHWyrxFIcWgQ_s0BMJlNSFqQfiTE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const ADMIN_EMAIL = "soosi.studio2025@gmail.com";
        const STAFF_EMAIL = "staff@soosi.com";

        const Icon = ({ name, size = 18, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({ root: iconRef.current, attrs: { "stroke-width": 2.5, class: className } });
                }
            }, [name, className]);
            return <span ref={iconRef} key={name} className="inline-flex items-center justify-center"><i data-lucide={name} style={{ width: size, height: size }}></i></span>;
        };

        // --- ç¿»è­¯èˆ‡æ ¼å¼åŒ–å·¥å…· ---
        const T = (key) => {
            if (key === true || key === 'true') return 'æ˜¯';
            if (key === false || key === 'false') return 'å¦';
            if (!key) return '-';
            
            const map = {
                'basic': 'å°ç¾å®¹', 'full': 'å¤§ç¾å®¹',
                'dog': 'ç‹—ç‹—', 'cat': 'è²“å’ª',
                'grooming': 'ç¾å®¹', 'boarding': 'ä½å®¿', 'daycare': 'å®‰è¦ª',
                'local_style': 'å±€éƒ¨ä¿®é£¾', 'special_style': 'ç‰¹æ®Šé€ å‹', 'scissor_cut': 'å…¨èº«æ‰‹å‰ª',
                'local_degrease': 'å±€éƒ¨å»æ²¹', 'full_degrease': 'å…¨èº«å»æ²¹',
                'spa_dental': 'å£è…”å‡è† ', 'spa_oil': 'æ½”è†šæ²¹', 'spa_ear': 'æ—¥æœ¬æ¡è€³',
                'spa_carbon': 'ç¢³é…¸æµ´', 'spa_bath': 'èˆ’æ•æµ´', 'spa_nano': 'å¥ˆç±³æµ´',
                'spa_salt': 'æµ·é¹½æµ´', 'spa_mud_exfoliate': 'å»è§’è³ªæ³¥', 'spa_bubble': 'æ³¡æ³¡æµ´', 'spa_volcano': 'ç«å±±æ³¥',
                'spa_ceramide_local': 'å±€éƒ¨ä¿æ¿•', 'spa_ceramide_full': 'å…¨èº«ä¿æ¿•',
                'other': 'å…¶ä»–é …ç›®'
            };
            return map[key] || key;
        };

        // --- æ¬Šé™é©—è­‰ Modal (æ”¹ç”¨ Supabase å¸³å¯†é©—è­‰) ---
        const SecurityModal = ({ isOpen, onClose, onConfirm, title = "æ•æ„Ÿæ“ä½œé©—è­‰" }) => {
            const [pwd, setPwd] = useState("");
            const [verifying, setVerifying] = useState(false);

            if (!isOpen) return null;

const handleVerify = async () => {
                setVerifying(true);
                try {
                    // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šå…ˆæª¢æŸ¥ç•¶å‰ç™»å…¥ç‹€æ…‹ï¼Œé¿å… user ç‚ºç©ºå°è‡´å ±éŒ¯
                    const { data: { user: currentUser }, error: userError } = await supabase.auth.getUser();
                    
                    if (userError || !currentUser) {
                        throw new Error("é©—è­‰å¤±æ•—ï¼šç™»å…¥è³‡è¨Šå·²éæœŸï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
                    }

                    // ä½¿ç”¨ç²å–åˆ°çš„ currentUser.email é€²è¡ŒäºŒæ®µé©—è­‰
                    const { error: loginError } = await supabase.auth.signInWithPassword({
                        email: currentUser.email,
                        password: pwd,
                    });

                    if (loginError) throw new Error("å¯†ç¢¼éŒ¯èª¤ï¼Œé©—è­‰å¤±æ•—");
                    
                    onConfirm(); // é©—è­‰é€šéï¼ŒåŸ·è¡Œåˆªé™¤æˆ–å„²å­˜å‹•ä½œ
                    setPwd("");
                    onClose();
                } catch (err) {
                    alert(err.message);
                } finally {
                    setVerifying(false);
                }
            };

            return (
                <div className="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl animate-in zoom-in-95">
                        <h3 className="font-black text-lg text-center mb-1">{title}</h3>
                        <p className="text-[10px] text-gray-400 text-center mb-4 font-bold">è«‹è¼¸å…¥æ‚¨çš„å¯†ç¢¼ä»¥ç¢ºèªè®Šæ›´</p>
                        <input type="password" autoFocus placeholder="æ‚¨çš„å¸³æˆ¶å¯†ç¢¼" 
                            className="w-full border-2 border-gray-200 rounded-xl p-3 text-center mb-4 outline-none focus:border-soosi-wood"
                            value={pwd} onChange={e=>setPwd(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleVerify()}
                        />
                        <div className="flex gap-2">
                            <button onClick={onClose} className="flex-1 py-2 bg-gray-100 rounded-lg text-xs font-bold text-gray-500">å–æ¶ˆ</button>
                            <button onClick={handleVerify} disabled={verifying} className="flex-1 py-2 bg-soosi-dark text-white rounded-lg text-xs font-bold">
                                {verifying ? 'é©—è­‰ä¸­...' : 'ç¢ºèª'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ç™»å…¥ View ---
        const LoginView = ({ onLogin }) => {
            const [loginEmail, setLoginEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const { data, error: authError } = await supabase.auth.signInWithPassword({ email: loginEmail, password });
                if (authError) {
                    setError('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
                    setLoading(false);
                } else {
                    onLogin();
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 relative overflow-hidden">
                    <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-soosi-green/20 rounded-full blur-3xl"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-80 h-80 bg-soosi-wood/10 rounded-full blur-3xl"></div>
                    
                    <div className="glass-card w-full max-w-md p-10 text-center relative z-10 animate-in zoom-in duration-500">
                        <img src="nav.png" className="w-40 mx-auto mb-6 drop-shadow-sm" alt="Soosi Logo" />
                        
                        {!loginEmail ? (
                            <div className="space-y-4">
                                <h1 className="text-xl font-black text-soosi-dark mb-6">å®¿æ´— Soosi | ç®¡ç†å¾Œå°</h1>
                                <button onClick={() => setLoginEmail(ADMIN_EMAIL)} className="w-full bg-white border-2 border-soosi-green/20 hover:border-soosi-green hover:bg-soosi-green/5 text-soosi-dark py-4 rounded-2xl font-black flex items-center justify-center gap-3 transition-all active:scale-95">
                                    <div className="w-10 h-10 rounded-full bg-soosi-green text-white flex items-center justify-center"><Icon name="shield" /></div>
                                    ç®¡ç†å“¡ç™»å…¥
                                </button>
                                <button onClick={() => setLoginEmail(STAFF_EMAIL)} className="w-full bg-white border-2 border-soosi-wood/20 hover:border-soosi-wood hover:bg-soosi-wood/5 text-soosi-dark py-4 rounded-2xl font-black flex items-center justify-center gap-3 transition-all active:scale-95">
                                    <div className="w-10 h-10 rounded-full bg-soosi-wood text-white flex items-center justify-center"><Icon name="user" /></div>
                                    å“¡å·¥ç™»å…¥
                                </button>
                                <a href="./index.html" className="inline-flex items-center gap-2 mb-6 text-xs font-bold text-soosi-wood hover:text-soosi-green transition-colors">
    <Icon name="arrow-left" size={14}/> è¿”å›å¡«å¯«é¦–é 
</a>
                            </div>
                        ) : (
                            <form onSubmit={handleLogin} className="space-y-4 animate-in fade-in slide-in-from-bottom-2">
<div className="text-center mb-4">
    <span className={`px-6 py-2 rounded-full text-sm font-black text-white shadow-sm ${loginEmail === ADMIN_EMAIL ? 'bg-soosi-green' : 'bg-soosi-wood'}`}>
        {loginEmail === ADMIN_EMAIL ? 'ç®¡ç†å“¡æ¨¡å¼' : 'å“¡å·¥æ¨¡å¼'}
    </span>
</div>
                                <input type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" value={password} onChange={e=>setPassword(e.target.value)} className="w-full text-center py-4 rounded-2xl border-2 border-soosi-green/20 focus:border-soosi-green outline-none font-black text-lg tracking-widest" autoFocus />
                                {error && <p className="text-soosi-red text-xs font-black">{error}</p>}
                                <button disabled={loading} className="w-full bg-soosi-dark text-white py-4 rounded-2xl font-black text-lg shadow-lg hover:opacity-90 transition-all flex items-center justify-center gap-2">
                                    {loading ? <Icon name="loader-2" className="animate-spin" /> : 'ç¢ºèªç™»å…¥'}
                                </button>
                                <button type="button" onClick={() => setLoginEmail('')} className="text-xs font-bold text-gray-400 hover:text-soosi-dark transition-colors">â† åˆ‡æ›èº«åˆ†</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };
// ğŸŒŸ ä¿®æ­£ï¼šRenderField ç¨ç«‹åœ¨å¤–éƒ¨ï¼Œä¸¦ç§»é™¤ copy/link åŠŸèƒ½
        const RenderField = ({ label, value, editPath, type = 'text', highlight = false, isEditing, onChange }) => (
            <div className="mb-2">
                <label className="text-[10px] font-bold text-gray-400 block mb-0.5">{label}</label>
                {isEditing ? (
                    <input 
                        type={type} 
                        value={value || ''} 
                        onChange={(e) => onChange(editPath, e.target.value)} 
                        className="admin-input"
                    />
                ) : (
                    <div className={`font-bold text-sm break-words ${highlight ? 'text-soosi-red' : 'text-soosi-dark'}`}>
                        {T(value)}
                    </div>
                )}
            </div>
        );
// --- è¨‚å–®è©³æƒ… Modal (ä¹¾æ·¨ç‰ˆï¼šç„¡è¤‡è£½/å°èˆªï¼Œéµç›¤æ­£å¸¸) ---
        const OrderModal = ({ user, order, onClose, onUpdateStatus, onUpdateNote, onDeleteOrder, onUpdateFullOrder }) => {
            if (!order) return null;
const [showReport, setShowReport] = useState(false);
            const [reportType, setReportType] = useState('grooming'); // ğŸŒŸ æ–°å¢ï¼šå€åˆ†å ±å‘Šé¡å‹
            const [localNote, setLocalNote] = useState(order.admin_note || '');
            const [isEditing, setIsEditing] = useState(false);
            const [showAuth, setShowAuth] = useState(false); 
const [showDeleteAuth, setShowDeleteAuth] = useState(false); 
            const [editData, setEditData] = useState(JSON.parse(JSON.stringify(order))); 
            
            // ğŸŒŸ æ–°å¢ï¼šé‡å¯„ä¿¡ä»¶ç‹€æ…‹
            const [isResending, setIsResending] = useState(false);

            // ğŸŒŸ æ–°å¢ï¼šé‡å¯„ä¿¡ä»¶å‡½å¼
            const handleResendEmail = async () => {
                if (!order.email) return alert("âŒ æ­¤è¨‚å–®æ²’æœ‰å¡«å¯« Emailï¼Œç„¡æ³•å¯„é€ã€‚");
                if (!confirm(`ç¢ºå®šè¦é‡å¯„å¥‘ç´„å‰¯æœ¬è‡³ ${order.email} å—ï¼Ÿ`)) return;

                setIsResending(true);
                try {
                    // é‡çµ„å‚³é€çµ¦ Edge Function çš„è³‡æ–™ (ç¢ºä¿èˆ‡ index.html æ ¼å¼ä¸€è‡´)
                    const rawProps = order.raw_data?.raw_data || order.raw_data || {};
const payload = {
                        ...rawProps,
                        owner_name: order.owner_name,
                        phone: order.phone,
                        email: order.email,
                        total_price: order.total_price,
                        isBoarding: ['boarding', 'daycare'].includes(order.service_type),
                        isDaycare: order.service_type === 'daycare',
                        signature_url: order.signature_url,
                        signed_at: order.created_at, // ğŸŒŸ å‚³å…¥ç•¶åˆç°½ç½²(è¨‚å–®æˆç«‹)çš„æ™‚é–“
                        petList: order.booking_pets.map(p => ({
                            ...p,
                            addGrooming: p.add_grooming, // è½‰æ›æ¬„ä½åç¨±ä»¥ç¬¦åˆå¾Œç«¯é æœŸ
                            boarding_grooming_price: p.boarding_grooming_price
                        }))
                    };

                    const resp = await fetch(`${supabaseUrl}/functions/v1/send-resend-email`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${supabaseKey}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) throw new Error("ç™¼é€å¤±æ•—");
                    alert("âœ… å¥‘ç´„å‰¯æœ¬å·²æˆåŠŸé‡æ–°å¯„å‡ºï¼");
                } catch (e) {
                    console.error("é‡å¯„å¤±æ•—:", e);
                    alert("âŒ é‡å¯„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ Edge Function ç‹€æ…‹ã€‚");
                } finally {
                    setIsResending(false);
                }
            };

            const isBoarding = order.service_type === 'boarding' || order.service_type === 'daycare';
            const getRaw = (key) => editData.raw_data?.raw_data?.[key] || editData.raw_data?.[key] || '';

            const handleNoteBlur = () => { if (localNote !== order.admin_note) onUpdateNote(order.id, localNote); };

            // è™•ç†ç·¨è¼¯è®Šæ›´
            const handleEditChange = (path, value) => {
                setEditData(prev => {
                    const newData = { ...prev };
                    if (path.startsWith('owner_')) newData[path] = value;
                    else if (path === 'phone' || path === 'email' || path === 'total_price') newData[path] = value;
                    else if (path.startsWith('raw_data.')) {
                        const key = path.split('.')[1];
                        if (!newData.raw_data) newData.raw_data = {};
                        if (!newData.raw_data.raw_data) newData.raw_data.raw_data = {}; 
                        newData.raw_data.raw_data[key] = value;
                    }
                    return newData;
                });
            };

            const saveChanges = () => { onUpdateFullOrder(editData); setIsEditing(false); };

const formatAge = (pet) => {
                const ageVal = pet.age;
                // 1. è™•ç†ç„¡è³‡æ–™æˆ– null çš„æƒ…æ³
                if (ageVal === null || ageVal === undefined || ageVal === '') return '-';

                const ageNum = parseFloat(ageVal);
                
                // 2. åˆ¤æ–·æ˜¯å¦æœªæ»¿ä¸€æ­² (æˆ–æ˜¯ age æ•¸å€¼å°æ–¼ 1)
                // è¨»ï¼šè³‡æ–™åº«å°æ•¸é» 0.0833 = 1å€‹æœˆ, 0.5 = 6å€‹æœˆ
                if (pet.is_under_one || ageNum < 1) {
                    const months = Math.round(ageNum * 12);
                    // ç¢ºä¿å¦‚æœå¤§æ–¼ 0 ä½†ç®—å‡ºä¾†æ˜¯ 0 (æ¥µå°æ•¸)ï¼Œä¹Ÿè‡³å°‘é¡¯ç¤º 1 å€‹æœˆ
                    const displayMonths = (months === 0 && ageNum > 0) ? 1 : months;
                    return <span className="text-soosi-accent font-bold">{displayMonths} å€‹æœˆ</span>;
                }
                
                // 3. è¶…éä¸€æ­²ç›´æ¥é¡¯ç¤ºæ­²æ•¸
                return `${ageNum} æ­²`;
            };

            const getPetTypeLabel = (pet) => {
                const type = pet.pet_type || 'dog';
                return type === 'cat' ? 'ğŸ± è²“å’ª' : 'ğŸ¶ ç‹—ç‹—';
            };
            
            const getVal = (pet, key) => pet[key] || getRaw(key);

// åƒ¹æ ¼æ˜ç´°é¡¯ç¤º Helper (ä¿®å¾© ReferenceError ä¸¦å¸¶å…¥å¯µç‰©åç¨±)
            const renderPriceDetails = () => {
                const pricePerNight = parseInt(getRaw('price_per_night') || 0);
                const holidaySurcharge = parseInt(getRaw('holiday_surcharge') || 0);
                
                // 1. è‡ªå‹•è¨ˆç®—ä½å®¿å¤©æ•¸ (é¿å…å¤©æ•¸æ¶ˆå¤±)
                let stayDuration = parseInt(getRaw('stayDuration') || 0);
                if (!stayDuration && order.check_in_date && order.check_out_date) {
                    const start = new Date(order.check_in_date);
                    const end = new Date(order.check_out_date);
                    stayDuration = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                }
                
                return (
                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 text-sm space-y-2 mb-4">
                        <div className="font-black text-gray-400 text-xs border-b border-gray-200 pb-2 mb-2 flex items-center gap-1">
                            <Icon name="file-text" size={14}/> è²»ç”¨æ˜ç´°
                        </div>

                        {/* --- 1. ä½å®¿/å®‰è¦ªé …ç›® --- */}
                        {isBoarding && stayDuration > 0 && pricePerNight > 0 && (
                            <>
                                <div className="flex justify-between">
                                    <span>ğŸ  ä½å®¿ ({stayDuration}æ™š)</span>
                                    <span className="font-bold">${stayDuration * pricePerNight}</span>
                                </div>
                                {stayDuration >= 6 && (
                                    <div className="flex justify-between text-soosi-green text-xs italic">
                                        <span>â”” {stayDuration >= 15 ? 'é•·ä½å„ªæƒ  (85æŠ˜)' : 'é•·ä½å„ªæƒ  (95æŠ˜)'}</span>
                                        <span>- ${Math.round(stayDuration * pricePerNight * (stayDuration >= 15 ? 0.15 : 0.05))}</span>
                                    </div>
                                )}
                                {holidaySurcharge > 0 && (
                                    <div className="flex justify-between text-soosi-red">
                                        <span>+ å‡æ—¥/ç‰¹æ®ŠåŠ åƒ¹</span>
                                        <span className="font-bold">${holidaySurcharge}</span>
                                    </div>
                                )}
                            </>
                        )}

                        {/* --- 2. ç¾å®¹èˆ‡ SPA é …ç›® --- */}
                        {editData.booking_pets?.map((pet, idx) => {
                            const hasGrooming = isBoarding ? pet.add_grooming : true;
                            const gPrice = parseInt(pet.grooming_price || 0);
                            
                            if (hasGrooming) {
                                return (
                                    <div key={idx} className="pt-1 border-t border-dashed border-gray-200 mt-1">
                                        <div className="flex justify-between text-soosi-dark font-black text-xs mb-1">
                                            <span>âœ‚ï¸ {pet.pet_name} æœå‹™é …ç›®</span>
                                            {isBoarding && <span className="text-soosi-green font-bold">+ ${gPrice}</span>}
                                        </div>
                                        <div className="pl-4 space-y-0.5">
                                            {(pet.service_items || []).map((item, i) => (
                                                <div key={i} className="text-[11px] text-gray-500">â€¢ {T(item)}</div>
                                            ))}
                                            {getRaw('service_items_other') && (
                                                <div className="text-[11px] text-gray-400 italic">â€¢ å‚™è¨»: {getRaw('service_items_other')}</div>
                                            )}
                                        </div>
                                    </div>
                                );
                            }
                            return null;
                        })}

                        {/* --- 3. å„ªæƒ æŠ˜æŠµ (è§£æ±º ReferenceError ä¸¦é¡¯ç¤ºå¯µç‰©å) --- */}
                        {(() => {
                            // æ‰¾å‡ºæœ‰å‹¾é¸å„ªæƒ çš„å¯µç‰© (æ”¯æ´è³‡æ–™åº«èˆ‡èˆŠè³‡æ–™æ ¼å¼)
                            const promoPets = editData.booking_pets?.filter(p => 
                                p.use_promo_50 === true || p.use_promo_50 === 'true' || 
                                p.usePromo50 === true || p.usePromo50 === 'true'
                            ) || [];
                            
                            // æª¢æŸ¥æ•´å–®æ˜¯å¦æœ‰å„ªæƒ æ¨™è¨˜
                            const isOrderPromo = (getRaw('usePromo50') === true || getRaw('usePromo50') === 'true') || 
                                               (getRaw('use_promo_50') === true || getRaw('use_promo_50') === 'true');
                            
                            if (promoPets.length > 0 || isOrderPromo) {
                                const names = promoPets.map(p => p.pet_name).filter(Boolean).join('ã€');
                                const label = names ? `(${names}) 50å¤©å„ªæƒ ` : `50å¤©å„ªæƒ `;
                                const totalDiscount = promoPets.length > 0 ? (promoPets.length * 200) : 200;

                                return (
                                    <div className="flex justify-between text-soosi-red border-t border-dashed border-gray-200 pt-2 font-bold animate-pulse">
                                        <span className="flex items-center gap-1">
                                            <Icon name="sparkles" size={12}/> {label}
                                        </span>
                                        <span>- ${totalDiscount}</span>
                                    </div>
                                );
                            }
                            return null;
                        })()}

                        {/* --- 4. ç¸½é¡ --- */}
                        <div className="border-t border-gray-300 pt-2 mt-2">
                            <div className="flex justify-between items-center">
                                <span className="font-black text-soosi-dark text-base">æ‡‰æ”¶ç¸½é¡</span>
                                {isEditing ? (
                                    <div className="flex items-center gap-1">
                                        <span className="font-bold text-gray-400">$</span>
                                        <input 
                                            type="number" 
                                            value={editData.total_price} 
                                            onChange={(e) => handleEditChange('total_price', e.target.value)}
                                            className="admin-input w-24 text-right font-black text-lg text-soosi-wood"
                                        />
                                    </div>
                                ) : (
                                    <span className="text-xl font-black text-soosi-wood">${editData.total_price}</span>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-soosi-dark/60 backdrop-blur-sm animate-in fade-in">
                    <div className="w-full max-w-4xl bg-[#F9F7F2] rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
                        {/* Header */}
                        <div className="bg-white px-8 py-5 flex justify-between items-center border-b border-gray-100 shrink-0">
                            <div>
                                <h3 className="font-black text-xl text-soosi-dark flex items-center gap-2">
                                    {isBoarding ? <Icon name="home" className="text-soosi-wood"/> : <Icon name="scissors" className="text-soosi-green"/>}
                                    {isBoarding ? (order.service_type === 'daycare' ? 'å®‰è¦ªè©³æƒ…' : 'ä½å®¿è©³æƒ…') : 'ç¾å®¹è©³æƒ…'}
                                    {isEditing && <span className="text-xs bg-red-100 text-red-500 px-2 py-1 rounded ml-2">ç·¨è¼¯æ¨¡å¼</span>}
                                </h3>
                                <p className="text-[10px] text-gray-400 font-bold tracking-widest uppercase">ID: {order.id.slice(0,8)}</p>
                            </div>
                            <div className="flex gap-2 items-center">
                                {user?.email === ADMIN_EMAIL && (
                                    !isEditing ? (
                                        <>
                                            <button onClick={() => setIsEditing(true)} className="p-2 bg-gray-100 hover:bg-soosi-wood hover:text-white rounded-full transition-colors">
                                                <Icon name="edit-2" size={18}/>
                                            </button>
                                            <button onClick={() => setShowDeleteAuth(true)} className="p-2 bg-red-50 hover:bg-red-500 hover:text-white text-red-400 rounded-full transition-colors">
                                                <Icon name="trash-2" size={18}/>
                                            </button>
                                        </>
                                    ) : (
                                        <button onClick={() => setShowAuth(true)} className="px-6 py-1.5 bg-soosi-green text-white rounded-xl text-xs font-black shadow-md active:scale-95 transition-all">å„²å­˜</button>
                                    )
                                )}
                                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors ml-1"><Icon name="x" size={24}/></button>
                            </div>
                        </div>

                        <div className="p-8 overflow-y-auto space-y-6">
                            {/* ç‹€æ…‹èˆ‡æŒ‰éˆ•å€ */}
                            <div className="grid md:grid-cols-2 gap-4">
                                <div className="bg-white p-5 rounded-3xl border border-soosi-green/10 shadow-sm">
                                    <label className="text-xs font-bold text-gray-400 mb-2 block">è¨‚å–®ç‹€æ…‹</label>
                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                        {['pending', 'confirmed', 'completed', 'cancelled'].map(status => (
                                            <button key={status} 
                                                onClick={()=>onUpdateStatus(order.id, status)} 
                                                className={`w-full py-3 rounded-xl text-xs font-bold border transition-all flex items-center justify-center ${
                                                    order.status === status 
                                                    ? 'bg-soosi-green text-white border-soosi-green shadow-md' 
                                                    : 'bg-white text-gray-400 border-gray-200 hover:border-soosi-green hover:text-soosi-green'
                                                }`}
                                            >
                                                {status === 'pending' ? 'å¾…ç¢ºèª' : status === 'confirmed' ? 'å·²ç¢ºèª' : status === 'completed' ? 'å·²å®Œæˆ' : 'å·²å–æ¶ˆ'}
                                            </button>
                                        ))}
                                    </div>
{/* ğŸŒŸ ä¿®æ­£ï¼šæŒ‰éˆ•æ‹†åˆ†ç‚ºã€Œç¾å®¹å ±å‘Šã€èˆ‡ã€Œä½å®¿å ±å‘Šã€ */}
                                    <div className="grid grid-cols-2 gap-2 mt-3">
                                        {/* ç¾å®¹å ±å‘ŠæŒ‰éˆ•ï¼šå¦‚æœæ˜¯ç¾å®¹å–®ç›´æ¥é¡¯ç¤ºï¼›è‹¥æ˜¯ä½å®¿å–®å‰‡åœ¨æœ‰åŠ è³¼ç¾å®¹æ™‚é¡¯ç¤º */}
                                        {(!isBoarding || (isBoarding && getRaw('addGrooming'))) && (
                                            <button onClick={() => { setReportType('grooming'); setShowReport(true); }} 
                                                className={`py-3 bg-soosi-green/10 text-soosi-green border-2 border-dashed border-soosi-green/20 rounded-xl font-black text-xs flex items-center justify-center gap-1 hover:bg-soosi-green hover:text-white transition-all group ${!isBoarding ? 'col-span-2' : ''}`}>
                                                <Icon name="scissors" size={16}/> ç”¢ç”Ÿç¾å®¹å ±å‘Š
                                            </button>
                                        )}
{isBoarding && (
                                            <button onClick={() => { setReportType('boarding'); setShowReport(true); }} 
                                                className={`py-3 bg-soosi-wood/10 text-soosi-wood border-2 border-dashed border-soosi-wood/20 rounded-xl font-black text-xs flex items-center justify-center gap-1 hover:bg-soosi-wood hover:text-white transition-all group ${!getRaw('addGrooming') ? 'col-span-2' : ''}`}>
                                                <Icon name="home" size={16}/> ç”¢ç”Ÿä½å®¿å ±å‘Š
                                            </button>
                                        )}
                                    </div>
                                    
                                    {/* ğŸŒŸ æ–°å¢ï¼šé‡å¯„ä¿¡ä»¶æŒ‰éˆ• */}
                                    <button 
                                        onClick={handleResendEmail}
                                        disabled={isResending || !order.email}
                                        className={`w-full mt-2 py-2 rounded-xl text-xs font-black border-2 transition-all flex items-center justify-center gap-2 ${
                                            !order.email 
                                            ? 'bg-gray-50 text-gray-300 border-gray-100 cursor-not-allowed' 
                                            : 'bg-white text-soosi-dark border-gray-200 hover:bg-gray-50 active:scale-95'
                                        }`}
                                    >
                                        {isResending ? <Icon name="loader-2" className="animate-spin" size={14}/> : <Icon name="mail" size={14}/>}
                                        {order.email ? `é‡å¯„å¥‘ç´„è‡³ä¿¡ç®± (${order.email})` : 'æœªå¡«å¯«ä¿¡ç®± (ç„¡æ³•é‡å¯„)'}
                                    </button>
                                </div>
                                <div className="bg-white p-5 rounded-3xl border border-soosi-wood/10 shadow-sm relative group">
                                    <label className="text-xs font-bold text-soosi-wood mb-1 flex items-center gap-1">
                                        <Icon name="sticky-note" size={14}/> åº—å®¶å‚™è¨» (å…§éƒ¨ç”¨)
                                    </label>
                                    <textarea 
                                        className="w-full h-20 bg-yellow-50/50 p-2 rounded-xl text-sm border border-transparent focus:border-soosi-wood outline-none resize-none"
                                        placeholder="åœ¨æ­¤è¼¸å…¥å‚™è¨»äº‹é …..."
                                        value={localNote}
                                        onChange={(e)=>setLocalNote(e.target.value)}
                                        onBlur={handleNoteBlur}
                                    />
                                    <div className="absolute bottom-2 right-2 text-[10px] text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity">è‡ªå‹•å„²å­˜</div>
                                </div>
                            </div>

                            {/* é£¼ä¸»èˆ‡é‡‘é¡å€å¡Š */}
                            <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100">
                                <h4 className="font-black text-soosi-dark mb-4 flex items-center gap-2 border-b border-dashed pb-2">
                                    <Icon name="user" size={18}/> é£¼ä¸»èˆ‡æ¬¾é …
                                </h4>
                                <div className="grid md:grid-cols-3 gap-6">
                                    <div className="md:col-span-2 grid grid-cols-2 gap-4">
                                        {/* ğŸŒŸ é—œéµä¿®æ­£ï¼šå·²ç§»é™¤ copy å’Œ isLinkï¼Œä¸¦å‚³å…¥ isEditing */}
                                        <RenderField label="å§“å" value={editData.owner_name} editPath="owner_name" isEditing={isEditing} onChange={handleEditChange} />
                                        <RenderField label="é›»è©±" value={editData.phone} editPath="phone" isEditing={isEditing} onChange={handleEditChange} />
                                        <RenderField label="Email" value={editData.email} editPath="email" isEditing={isEditing} onChange={handleEditChange} />
                                        <RenderField label="èº«åˆ†è­‰å­—è™Ÿ" value={getRaw('owner_id')} editPath="raw_data.owner_id" isEditing={isEditing} onChange={handleEditChange} />
                                        
                                        <div className="col-span-2">
                                            <RenderField label="åœ°å€" value={getRaw('address')} editPath="raw_data.address" isEditing={isEditing} onChange={handleEditChange} />
                                        </div>
                                        
                                        <RenderField label="ç·Šæ€¥è¯çµ¡äºº" value={getRaw('emergency_name')} editPath="raw_data.emergency_name" isEditing={isEditing} onChange={handleEditChange} />
                                        <RenderField label="ç·Šæ€¥é›»è©±" value={getRaw('emergency_phone')} editPath="raw_data.emergency_phone" isEditing={isEditing} onChange={handleEditChange} />
                                        <RenderField label="æŒ‡å®šé†«é™¢" value={getRaw('preferred_clinic')} editPath="raw_data.preferred_clinic" isEditing={isEditing} onChange={handleEditChange} />
                                        
                                        <div className="col-span-2 flex gap-4">
                                            <div className="flex-1">
                                                <label className="text-[10px] font-bold text-gray-400 block mb-0.5">å½±åƒæˆæ¬Š</label>
                                                <div className={`font-bold text-sm ${getRaw('image_auth') === 'agree' ? 'text-soosi-green' : 'text-soosi-red'}`}>
                                                    {getRaw('image_auth') === 'agree' ? 'âœ… åŒæ„' : 'âŒ ä¸åŒæ„'}
                                                </div>
                                            </div>
                                            {getRaw('isDaycare') && (
                                                <div className="flex-1">
                                                    <label className="text-[10px] font-bold text-gray-400 block mb-0.5">å®‰è¦ªæ™‚æ®µ</label>
                                                    <div className="font-bold text-sm">{getRaw('bookingTime')} ~ {getRaw('bookingTimeEnd')}</div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="md:col-span-1">
                                        {renderPriceDetails()}
                                        {getRaw('proof_url') && (
                                            <div className="mt-2 text-center">
                                                <a href={getRaw('proof_url')} target="_blank" className="inline-block px-3 py-1 bg-orange-100 text-orange-600 rounded-lg text-xs font-bold hover:bg-orange-200">
                                                    ğŸ“„ æŸ¥çœ‹æ´—æ¾¡è­‰æ˜
                                                </a>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* å¯µç‰©åˆ—è¡¨ (ä¿æŒä¸è®Š) */}
                            <div>
                                <h4 className="font-black text-soosi-dark mb-4 flex items-center gap-2 ml-1">
                                    <Icon name="paw-print" size={20} className="text-soosi-wood"/> 
                                    å¯µç‰©è©³ç´°è³‡æ–™ ({editData.booking_pets?.length || 0} éš»)
                                </h4>
                                <div className="space-y-4">
                                    {editData.booking_pets?.map((pet, idx) => (
                                        <div key={idx} className="bg-white p-6 rounded-[2rem] border-2 border-soosi-green/10 shadow-sm relative">
                                            <div className="absolute top-4 right-4 text-[10px] text-gray-300 font-bold">#{idx + 1}</div>
                                            
                                            {/* ç¬¬ä¸€æ’ï¼šåŸºæœ¬è³‡æ–™ */}
                                            <div className="grid md:grid-cols-4 gap-4 mb-4 border-b border-dashed pb-4">
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-400">åå­— / ç¨®é¡</label>
                                                    <div className="text-lg font-black text-soosi-dark flex items-center gap-2">
                                                        {pet.pet_name}
                                                        <span className="text-xs bg-gray-100 px-2 py-0.5 rounded-full font-bold text-gray-500">{getPetTypeLabel(pet)}</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-400">å“ç¨®/èŠ±è‰²</label>
                                                    <div className="font-bold">{pet.breed}</div>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-400">åŸºæœ¬è³‡è¨Š</label>
                                                    <div className="font-bold">
                                                        {pet.sex} 
                                                        <span className={`text-xs ml-1 ${pet.fix === 'æ˜¯' ? 'text-gray-400' : 'text-soosi-red'}`}>
                                                            ({pet.fix === 'æ˜¯' ? 'å·²çµç´®' : 'æœªçµç´®'})
                                                        </span> 
                                                        / {formatAge(pet)} / {pet.weight}kg
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-400">æ™¶ç‰‡è™Ÿç¢¼</label>
                                                    <div className="font-bold text-xs">{getVal(pet, 'chip_id') || T(getVal(pet, 'chip_status'))}</div>
                                                </div>
                                            </div>

                                            {/* ç¬¬äºŒæ’ï¼šè©³ç´°èª¿æŸ¥ */}
                                            <div className="grid md:grid-cols-2 gap-x-8 gap-y-3 text-sm">
                                                {/* å·¦å´ï¼šå€‹æ€§èˆ‡å¥åº· */}
                                                <div className="space-y-2">
                                                    <div className="flex justify-between border-b border-gray-50 pb-1">
                                                        <span className="text-gray-400 text-xs">æ”»æ“Šæ€§/ç¤¾äº¤</span>
                                                        <div className="text-right">
                                                            <span className={`font-bold ${getVal(pet, 'social_aggression') === 'æœ‰æ”»æ“Šæ€§' ? 'text-red-500' : 'text-soosi-dark'}`}>
                                                                {getVal(pet, 'social_aggression') || 'ç„¡è³‡æ–™'}
                                                            </span>
                                                            <span className="text-xs text-gray-400 mx-1">/</span>
                                                            <span className="font-bold text-xs text-soosi-wood">
                                                                {getVal(pet, 'social_play') || '-'}
                                                            </span>
                                                        </div>
                                                    </div>

                                                    <div className="flex justify-between border-b border-gray-50 pb-1">
                                                        <span className="text-gray-400 text-xs">å€‹æ€§/åˆ†é›¢ç„¦æ…®</span>
                                                        <span className="font-bold text-right max-w-[200px] truncate" title={pet.personality}>{pet.personality || '-'}</span>
                                                    </div>
                                                    <div className="flex justify-between border-b border-gray-50 pb-1">
                                                        <span className="text-gray-400 text-xs">ç‰¹æ®Šæ³¨æ„äº‹é …</span>
                                                        <span className="font-bold text-right text-soosi-red max-w-[200px] truncate" title={getVal(pet, 'specialNotes')}>{getVal(pet, 'specialNotes') || 'ç„¡'}</span>
                                                    </div>
                                                    <div className="flex justify-between border-b border-gray-50 pb-1">
                                                        <span className="text-gray-400 text-xs">éæ•æº</span>
                                                        <span className="font-bold text-right text-soosi-red">{getVal(pet, 'allergies') || 'ç„¡'}</span>
                                                    </div>
                                                    <div className="flex justify-between border-b border-gray-50 pb-1">
                                                        <span className="text-gray-400 text-xs">ç¾å®¹æ€§æƒ…</span>
                                                        <span className="font-bold text-right">{getVal(pet, 'grooming_temperament')}</span>
                                                    </div>
                                                    
                                                    <div className="border-b border-gray-50 pb-1">
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400 text-xs">éå¾€ç—…å²</span>
                                                            <span className="font-bold text-right text-soosi-red">
                                                                {pet.medical_status === 'æœ‰' ? (pet.medical_history||[]).join(',') : 'ç„¡'}
                                                            </span>
                                                        </div>
                                                        {getVal(pet, 'medical_history_other') && (
                                                            <div className="text-[10px] text-red-400 text-right mt-0.5">({getVal(pet, 'medical_history_other')})</div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* å³å´ï¼šé£²é£Ÿèˆ‡ç¿’æ…£ */}
                                                <div className="space-y-2">
                                                    <div className="border-b border-gray-50 pb-1">
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400 text-xs">ç–«è‹—/é©…èŸ²</span>
                                                            <div className="text-right">
                                                                <span className="font-bold">{getVal(pet, 'vaccine')}</span> / 
                                                                <span className="font-bold ml-1">{getVal(pet, 'deworm')}</span>
                                                            </div>
                                                        </div>
                                                        <div className="flex justify-end gap-2 mt-1">
                                                            {getVal(pet, 'deworm_brand') && <span className="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">{getVal(pet, 'deworm_brand')}</span>}
                                                            {getVal(pet, 'vaccine_url') && <a href={getVal(pet, 'vaccine_url')} target="_blank" className="text-[10px] text-blue-500 underline">æŸ¥çœ‹æ‰‹å†Š</a>}
                                                        </div>
                                                    </div>

                                                    <div className="border-b border-gray-50 pb-1">
                                                        <div className="flex justify-between">
                                                            <span className="text-gray-400 text-xs">é£²é£Ÿç¿’æ…£</span>
                                                            <span className="font-bold text-right">{(getVal(pet, 'diet_type')||[]).join(',')}</span>
                                                        </div>
                                                        {(getVal(pet, 'diet_type_other') || getVal(pet, 'feeding_plan')) && (
                                                            <div className="text-[10px] text-gray-500 text-right mt-0.5 leading-tight">
                                                                {getVal(pet, 'diet_type_other')} {getVal(pet, 'feeding_plan')}
                                                            </div>
                                                        )}
                                                        {getVal(pet, 'pica') === 'æœ‰' && (
                                                            <div className="text-[10px] text-red-500 text-right font-bold mt-0.5">âš ï¸ ç•°é£Ÿç™–ï¼š{getVal(pet, 'pica_note')}</div>
                                                        )}
                                                    </div>

                                                    <div className="border-b border-gray-50 pb-1">
                                                        <div className="flex justify-between mb-1">
                                                            <span className="text-gray-400 text-xs">ç”Ÿæ´»ç¿’æ…£</span>
                                                            {pet.pet_type === 'dog' && isBoarding && (
                                                                <span className={`text-[10px] font-bold px-1.5 rounded ${getVal(pet, 'hasTrialStay') ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                                                    {getVal(pet, 'hasTrialStay') ? 'âœ… å·²è©¦ä½' : 'âŒ æœªè©¦ä½'}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="text-right text-[10px] font-bold leading-tight text-gray-600">
                                                            {getVal(pet, 'litter_type') && <div>è²“ç ‚: {getVal(pet, 'litter_type')}</div>}
                                                            {getVal(pet, 'isBarking') === 'æœƒ' && <div>ğŸ”Š æœƒå å«</div>} 
                                                            {getVal(pet, 'isFoodGuarding') === 'æœƒ' && <div>ğŸ¥£ æœƒè­·é£Ÿ</div>}
{getVal(pet, 'useToiletPad') === 'æœƒ' && <div>ğŸš½ ç”¨å°¿å¸ƒå¢Š</div>}
                                                            {getVal(pet, 'isWalking') === 'æ˜¯' && <div>ğŸŒ³ å¤–å‡ºæ•£æ­¥</div>}
                                                            {getVal(pet, 'isWalking') === 'å¦' && <div>ğŸš« ä¸å¤–å‡ºæ•£æ­¥</div>}
                                                            {getVal(pet, 'hasBoardingExp') === 'æœ‰' && <div>ğŸ  æœ‰ä½å®¿ç¶“é©—</div>}
                                                            
                                                            {(getVal(pet, 'crateTraining')||[]).length > 0 && (
                                                                <div className="mt-1 text-soosi-wood bg-soosi-wood/5 p-1 rounded">
                                                                    ç± å…§è¨“ç·´ï¼š{(getVal(pet, 'crateTraining')||[]).join('ã€')}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {pet.add_grooming && (
                                                <div className="mt-4 bg-soosi-green/5 p-3 rounded-xl">
                                                    <div className="font-black text-soosi-green text-xs mb-2">åŠ è³¼ç¾å®¹é …ç›® (${pet.boarding_grooming_price})</div>
                                                    <div className="flex flex-wrap gap-1.5">
                                                        {pet.service_items?.map((item, i) => (
                                                            <span key={i} className="text-[10px] bg-white text-soosi-green px-2.5 py-1 rounded-full font-black border border-soosi-green/10 shadow-sm">{T(item)}</span>
                                                        ))}
                                                        {getVal(pet, 'service_items_other') && (
                                                            <span className="text-[10px] bg-white text-gray-500 px-2.5 py-1 rounded-full border border-gray-200">{getVal(pet, 'service_items_other')}</span>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>

{/* ç°½åèˆ‡æ™‚é–“ (ä¿®æ­£é¡è‰²ç‚ºæ·±è‰²ä»¥æå‡è¾¨è­˜åº¦) */}
                            {order.signature_url && (
                                <div className="text-center pt-4 border-t border-dashed border-gray-200">
                                    <label className="text-[10px] font-black text-soosi-dark/50 block mb-2 uppercase tracking-widest">å®¢æˆ¶æ•¸ä½ç°½ç½²</label>
                                    <img src={order.signature_url} className="h-24 mx-auto opacity-80 mix-blend-multiply" />
                                    <div className="text-[11px] text-soosi-dark font-black mt-2 font-mono">
                                        ç°½ç½²æ™‚é–“ï¼š{new Date(order.created_at).toLocaleString('zh-TW', {hour12: false})}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <SecurityModal 
                        isOpen={showAuth} 
                        onClose={()=>setShowAuth(false)} 
                        onConfirm={saveChanges} 
                        title="ç¢ºèªå„²å­˜è®Šæ›´"
                    />
                    <SecurityModal 
                        isOpen={showDeleteAuth} 
                        onClose={()=>setShowDeleteAuth(false)} 
                        onConfirm={()=>onDeleteOrder(order.id)} 
                        title="âš ï¸ å±éšªæ“ä½œï¼šåˆªé™¤è¨‚å–®"
                    />
                    <ReportGeneratorModal 
                        isOpen={showReport} 
                        onClose={() => setShowReport(false)} 
                        order={order}
                        reportType={reportType}
                    />
                </div>
            );
        };
        
// --- æ™ºæ…§å ±å‘Šç”Ÿæˆå™¨ (æ”¯æ´ ç¾å®¹å®Œå·¥ / ä½å®¿æ—¥è¨˜ / ä½å®¿é€€æˆ¿) ---
const ReportGeneratorModal = ({ isOpen, onClose, order, reportType }) => { // ğŸŒŸ æ¥æ”¶åƒæ•¸
            const [activeTab, setActiveTab] = useState('finish'); // 'daily'(æ—¥è¨˜) æˆ– 'finish'(å®Œå·¥/é€€æˆ¿)
            
            // è³‡æ–™ç‹€æ…‹
            const [reportData, setReportData] = useState({
                // é€šç”¨
                feeDetail: '',
                overtime: '',
                // ç¾å®¹/é€€æˆ¿å°ˆç”¨
                general: 'ç²¾ç¥é£Ÿæ…¾è‰¯å¥½ï¼Œç‹€æ³ç©©å®šã€‚', 
                skin: 'çš®è†šæª¢æŸ¥ç„¡æ˜é¡¯ç•°å¸¸ã€‚',
// ä½å®¿æ—¥è¨˜å°ˆç”¨
                dailyMood: 'ğŸŸ¢ é–‹å¿ƒ',
                dailyMoodCustom: '', // âœ¨ æ–°å¢
                dailyEat: 'ğŸŸ¢ å®Œé£Ÿ',
                dailyEatCustom: '', // âœ¨ æ–°å¢
                dailyToilet: 'ğŸŸ¢ æ­£å¸¸',
                dailyToiletCustom: '', // âœ¨ æ–°å¢
                dailyCare: 'âšª ç„¡',
                dailyCareCustom: '', // âœ¨ æ–°å¢
                dailyNote: ''            });

            // åˆå§‹åŒ–ï¼šåˆ¤æ–·è¨‚å–®é¡å‹èˆ‡é è¨­å€¼
            useEffect(() => {
                if (isOpen && order) {
                    const isBoarding = ['boarding', 'daycare'].includes(order.service_type);
                    
// ğŸŒŸ ä¿®æ­£ï¼šæ ¹æ“šé»æ“Šçš„æŒ‰éˆ•é¡å‹ (reportType) æ±ºå®šé è¨­åˆ†é 
                    setActiveTab(reportType === 'boarding' ? 'daily' : 'finish');

                    // 1. æ—¥æœŸè™•ç†
                    const today = new Date();
                    const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
                    
                    // 2. è²»ç”¨é è¨­
                    const feeStr = `æœ¬æ¬¡æ¶ˆè²»ç¸½è¨ˆï¼š$${order.total_price}`;

                    setReportData(prev => ({
                        ...prev,
                        feeDetail: feeStr,
                        dailyNote: 'ä»Šå¤©åœ¨éŠæˆ²å€ç©å¾—å¾ˆé–‹å¿ƒå–”ï¼', // æ—¥è¨˜é è¨­æ–‡æ¡ˆ
                        overtime: '' // é‡ç½®é€¾æ™‚è²»
                    }));
                }
            }, [isOpen, order]);

            if (!isOpen || !order) return null;

            const isBoarding = ['boarding', 'daycare'].includes(order.service_type);

            // --- æ ¸å¿ƒï¼šç”¢ç”Ÿæ–‡å­—é‚è¼¯ ---
            const generateText = () => {
                const petsName = order.booking_pets.map(p => p.pet_name).join('ã€');
                const today = new Date();
                const dateText = `${today.getMonth() + 1}/${today.getDate()}`;

// --- A. ä½å®¿æ¯æ—¥æ—¥è¨˜æ¨¡å¼ (æ•¸ä½åŒ– PDF) ---
if (isBoarding && activeTab === 'daily') {
    const mood = reportData.dailyMood === 'â­ å…¶ä»–...' ? reportData.dailyMoodCustom : reportData.dailyMood;
    const eat = reportData.dailyEat === 'â­ å…¶ä»–...' ? reportData.dailyEatCustom : reportData.dailyEat;
    const toilet = reportData.dailyToilet === 'â­ å…¶ä»–...' ? reportData.dailyToiletCustom : reportData.dailyToilet;
    
// ğŸŒŸ ä¿®æ­£ï¼šè®“æ‰“å­—å…§å®¹æ¥åœ¨ç‹€æ…‹ï¼ˆå¦‚ï¼šå·²å®Œæˆï¼‰å¾Œé¢é¡¯ç¤º
    const careValue = reportData.dailyCare === 'â­ å…¶ä»–...' 
        ? (reportData.dailyCareCustom || '') 
        : `${reportData.dailyCare}${reportData.dailyCareCustom ? ` (${reportData.dailyCareCustom})` : ''}`;

    const careLine = reportData.dailyCare !== 'âšª ç„¡' 
        ? `ğŸ¥ ç‰¹æ®Šç…§é¡§/æŠ•è—¥ç´€éŒ„ï¼š${careValue}\n` 
        : '';

    return `ã€${dateText} ä½å®¿æ—¥è¨˜ ğŸ“ã€‘\n` +
           `æˆ‘æ˜¯ ${petsName} ï½é€™æ˜¯ä»Šå¤©çš„ä½å®¿ç‹€æ³å›å ±ï¼š\n\n` +
           `âœ¨ ç²¾ç¥ç‹€æ³ï¼š${mood}\n` +
           `ğŸ¥£ ç”¨é¤æƒ…å½¢ï¼š${eat}\n` +
           `ğŸ’© æ’æ³„ç‹€æ³ï¼š${toilet}\n` +
           `${careLine}\n` + // ğŸŒŸ é€™è£¡æœƒæ ¹æ“šæ˜¯å¦æœ‰å¡«å¯«ä¾†æ±ºå®šè¦ä¸è¦æ›è¡Œé¡¯ç¤º
           `ğŸ“ å°ç®¡å®¶ç­†è¨˜ï¼š\n${reportData.dailyNote}\n\n` +
           `ğŸ“¸ (ç…§ç‰‡/å½±ç‰‡å°‡å¦è¡Œå‚³é€)\n` +
           `--------------------------------\n` +
           `æœ‰ä»»ä½•å•é¡Œéš¨æ™‚éƒ½å¯ä»¥è©¢å•å–”ï¼`;
}

                // --- B. å®Œå·¥/é€€æˆ¿é€šçŸ¥æ¨¡å¼ (åŒ…å«ç¾å®¹èˆ‡ä½å®¿é€€æˆ¿) ---
// è™•ç†å¯µç‰©åèˆ‡æœå‹™é¡å‹ (ğŸŒŸ æ ¹æ“š reportType å¼·åˆ¶æ±ºå®šæ¨™ç±¤)
                const petInfo = order.booking_pets.map(p => {
                    let service = reportType === 'grooming' ? 'ç¾å®¹' : 'ä½å®¿é€€æˆ¿';
                    if (reportType === 'boarding' && order.service_type === 'daycare') service = 'å®‰è¦ªæ¥å›';
                    
                    // å¦‚æœæ˜¯ç¾å®¹å ±å‘Šï¼Œç´°åˆ†å¤§å°ç¾å®¹
                    if (reportType === 'grooming') {
                        if (p.service_items?.includes('basic')) service = 'å°ç¾å®¹';
                        if (p.service_items?.includes('full')) service = 'å¤§ç¾å®¹';
                    }
                    return `${p.pet_name}(${service})`;
                }).join('ã€');

// --- B. å®Œå·¥/é€€æˆ¿é€šçŸ¥æ¨¡å¼ (ä¿®æ­£ï¼šåªæœ‰ç´”ç¾å®¹å–®èˆ‡ä½å®¿å ±å‘Šæ‰é¡¯ç¤ºè²»ç”¨) ---
                const showFee = reportType === 'boarding' || (reportType === 'grooming' && !isBoarding);
                
                const baseInfo = `ã€${dateText} ${petInfo}ã€‘\n` +
                                 `æ•´é«”ç‹€æ³ - ${reportData.general}\n` +
                                 `çš®è†šç‹€æ³ - ${reportData.skin}\n\n` +
                                 (showFee ? `è²»ç”¨æ˜ç´°ï¼š\n${reportData.feeDetail}\n\n` : '') +
                                 `--------------------------------\n`;
                if (reportType === 'grooming') {
                    return baseInfo +
                           `âœ¨ [ ${petsName} ] æ´—é¦™é¦™å®Œç•¢å›‰ï¼\n` +
                           `ğŸ“¸ (ç…§ç‰‡/å½±ç‰‡å°‡å¦è¡Œå‚³é€)\n` +
                           (isBoarding ? '' : `â€”\nè«‹æ–¼é€šçŸ¥å¾Œå…©å°æ™‚å…§æ¥å›ï¼Œé€¾æ™‚å°‡ä¾å®‰è¦ªè²»è¨ˆè²»ï¼š\n${reportData.overtime || '(å°šæœªé¸æ“‡è²»ç‡)'}\n`) +
                           `â€”\næœ‰ä»»ä½•å•é¡Œéš¨æ™‚éƒ½å¯ä»¥è©¢å•~`;
                }

                return baseInfo +
                       `ğŸ‰ å¯ä»¥ä¾†æ¥ [ ${petsName} ] å›å®¶å›‰!\n` +
                       `è¬è¬ä½ å€‘çš„ä¿¡ä»»ï¼ŒæœŸå¾…ä¸‹æ¬¡å†ä¾†ç©ï½ï½\n` +
                       `â€”\næœ‰ä»»ä½•å•é¡Œéš¨æ™‚éƒ½å¯ä»¥è©¢å•~`;
            };

            const handleCopy = () => {
                const text = generateText();
                navigator.clipboard.writeText(text).then(() => {
                    alert("âœ… å ±å‘Šå·²è¤‡è£½ï¼è«‹åˆ‡æ›åˆ° LINE è²¼ä¸Šã€‚");
                    onClose();
                });
            };

            return (
                <div className="fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-white rounded-[2rem] w-full max-w-md shadow-2xl flex flex-col max-h-[90vh] animate-in zoom-in-95">
                        
                        {/* Header & Tabs */}
                        <div className="bg-soosi-wood p-5 text-white rounded-t-[2rem] shrink-0">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-black text-lg flex items-center gap-2"><Icon name="message-square"/> è¨Šæ¯ç”¢ç”Ÿå™¨</h3>
                                <button onClick={onClose}><Icon name="x"/></button>
                            </div>
                            
                            {/* ä½å®¿å–®é¡¯ç¤ºåˆ†é åˆ‡æ› */}
                            {isBoarding && (
                                <div className="flex bg-black/20 p-1 rounded-xl">
                                    <button onClick={() => setActiveTab('daily')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${activeTab === 'daily' ? 'bg-white text-soosi-wood shadow-md' : 'text-white/70 hover:text-white'}`}>
                                        ğŸ“ æ¯æ—¥æ—¥è¨˜
                                    </button>
                                    <button onClick={() => setActiveTab('finish')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${activeTab === 'finish' ? 'bg-white text-soosi-wood shadow-md' : 'text-white/70 hover:text-white'}`}>
                                        ğŸ  é€€æˆ¿é€šçŸ¥
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Body */}
                        <div className="p-6 overflow-y-auto space-y-5 bg-[#F9F7F2] flex-1">
                            
                            {/* æ¨¡å¼ A: æ¯æ—¥æ—¥è¨˜ (ä½å®¿å°ˆç”¨) */}
                            {activeTab === 'daily' && (
                                <div className="space-y-4 animate-in slide-in-from-right">
<div className="grid grid-cols-3 gap-3">
                                        {[
                                            { label: 'ç²¾ç¥', key: 'dailyMood', custom: 'dailyMoodCustom', opts: ['ğŸŸ¢ é–‹å¿ƒ', 'ğŸŸ¡ æ™®é€š', 'ğŸ”´ é¬±å’', 'â­ å…¶ä»–...'] },
                                            { label: 'é£Ÿæ…¾', key: 'dailyEat', custom: 'dailyEatCustom', opts: ['ğŸŸ¢ å®Œé£Ÿ', 'ğŸŸ¡ åƒä¸€åŠ', 'ğŸ”´ ä¸åƒ', 'â­ å…¶ä»–...'] },
                                            { label: 'æ’æ³„', key: 'dailyToilet', custom: 'dailyToiletCustom', opts: ['ğŸŸ¢ æ­£å¸¸', 'ğŸŸ¡ è»Ÿä¾¿', 'ğŸ”´ æœªæ’', 'â­ å…¶ä»–...'] }
                                        ].map((field) => (
                                            <div key={field.key} className="space-y-1">
                                                <label className="text-xs font-bold text-gray-500 block text-center">{field.label}</label>
                                                <select 
                                                    value={reportData[field.key]} 
                                                    onChange={e => setReportData({...reportData, [field.key]: e.target.value})}
                                                    className="w-full p-2 rounded-xl border border-gray-200 text-xs font-bold text-center outline-none focus:border-soosi-wood"
                                                >
                                                    {field.opts.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                </select>
                                                {/* âœ¨ é¸åˆ°ã€Œå…¶ä»–ã€æ™‚ï¼Œé¡¯ç¤ºç©ºç™½æ–‡å­—æ¡†ä¾›å¡«å¯« */}
                                                {reportData[field.key] === 'â­ å…¶ä»–...' && (
                                                    <input 
                                                        type="text"
                                                        placeholder="è‡ªè¡Œå¡«å¯«"
                                                        value={reportData[field.custom]}
                                                        onChange={e => setReportData({...reportData, [field.custom]: e.target.value})}
                                                        className="w-full mt-1 p-1 rounded-lg border border-gray-200 text-[10px] font-bold outline-none focus:border-soosi-wood animate-in fade-in"
                                                    />
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    <div>
                                        {/* ğŸŒŸ æ–°å¢ï¼šç‰¹æ®Šç…§é¡§ç´€éŒ„å€ */}
                                    <div className="bg-white p-3 rounded-xl border border-blue-100 space-y-2">
                                        <div className="flex justify-between items-center">
                                            <label className="text-xs font-bold text-blue-600 flex items-center gap-1">
                                                <Icon name="pills" size={14}/> ç‰¹æ®Šç…§é¡§ / æŠ•è—¥ç´€éŒ„
                                            </label>
                                            <select 
                                                value={reportData.dailyCare} 
                                                onChange={e => setReportData({...reportData, dailyCare: e.target.value})}
                                                className="text-[10px] font-bold border-none bg-transparent text-blue-500 outline-none"
                                            >
                                                <option value="âšª ç„¡">âšª ç„¡</option>
                                                <option value="âœ… å·²å®Œæˆ">âœ… å·²å®Œæˆ</option>
                                                <option value="âš ï¸ éœ€æ³¨æ„">âš ï¸ éœ€æ³¨æ„</option>
                                                <option value="â­ å…¶ä»–...">â­ å…¶ä»–...</option>
                                            </select>
                                        </div>
                                        {/* ç•¶ç‹€æ…‹ä¸æ˜¯ã€Œç„¡ã€çš„æ™‚å€™ï¼Œé¡¯ç¤ºè£œå……èªªæ˜æ¡† */}
                                        {reportData.dailyCare !== 'âšª ç„¡' && (
                                            <input 
                                                type="text"
                                                placeholder="ä¾‹å¦‚ï¼šæ—©æ™šé¤µè—¥ã€å™´å£è…”å™´åŠ‘..."
                                                value={reportData.dailyCareCustom}
                                                onChange={e => setReportData({...reportData, dailyCareCustom: e.target.value})}
                                                className="w-full p-2 rounded-lg bg-blue-50/50 border border-blue-100 text-xs font-bold outline-none focus:border-blue-400 animate-in slide-in-from-top-1"
                                            />
                                        )}
                                    </div>
                                        <label className="text-xs font-bold text-soosi-wood mb-1 block">å°ç®¡å®¶ç­†è¨˜</label>
                                        <textarea value={reportData.dailyNote} onChange={e=>setReportData({...reportData, dailyNote: e.target.value})} className="w-full p-3 rounded-xl border border-gray-200 text-sm h-24 resize-none focus:border-soosi-wood outline-none" placeholder="æè¿°ä»Šå¤©çš„äº’å‹•ç‹€æ³..."/>
                                    </div>
                                </div>
                            )}

                            {/* æ¨¡å¼ B: å®Œå·¥/é€€æˆ¿é€šçŸ¥ (é€šç”¨) */}
                            {activeTab === 'finish' && (
                                <div className="space-y-4 animate-in slide-in-from-left">
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs font-bold text-soosi-wood mb-1 block">æ•´é«”ç‹€æ³</label>
                                            <textarea value={reportData.general} onChange={e=>setReportData({...reportData, general: e.target.value})} className="w-full p-2 rounded-xl border border-gray-200 text-sm h-16 resize-none focus:border-soosi-wood outline-none"/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-soosi-wood mb-1 block">çš®è†š/å¤–è§€ç‹€æ³</label>
                                            <textarea value={reportData.skin} onChange={e=>setReportData({...reportData, skin: e.target.value})} className="w-full p-2 rounded-xl border border-gray-200 text-sm h-16 resize-none focus:border-soosi-wood outline-none"/>
                                        </div>
                                    </div>
{/* åªæœ‰ã€Œä½å®¿å ±å‘Šã€æˆ–ã€Œä¸€èˆ¬ç¾å®¹å–®çš„ç¾å®¹å ±å‘Šã€æ‰é¡¯ç¤ºè²»ç”¨è¼¸å…¥æ¡† */}
                                    {(reportType === 'boarding' || (reportType === 'grooming' && !isBoarding)) && (
                                        <div>
                                            <label className="text-xs font-bold text-soosi-wood mb-1 block">è²»ç”¨æ˜ç´°</label>
                                            <textarea value={reportData.feeDetail} onChange={e=>setReportData({...reportData, feeDetail: e.target.value})} className="w-full p-2 rounded-xl border border-gray-200 text-sm h-16 resize-none focus:border-soosi-wood outline-none"/>
                                        </div>
                                    )}
{/* åªæœ‰ã€Œä¸€èˆ¬ç¾å®¹å–®ã€ä¸”ã€Œå®Œå·¥åˆ†é ã€æ‰é¡¯ç¤ºé€¾æ™‚è²»ç‡æŒ‰éˆ• */}
{!isBoarding && reportType === 'grooming' && activeTab === 'finish' && (
    <div className="bg-white p-3 rounded-xl border border-soosi-wood/10">
        <label className="text-xs font-bold text-soosi-wood mb-2 block flex items-center gap-1">
            <Icon name="clock" size={12}/> é€¾æ™‚è²»ç‡ (é»æ“Šå¸¶å…¥)
        </label>
        <div className="grid grid-cols-2 gap-2">
            {[
                "å°å‹çŠ¬(5kgä¸‹)ï¼š$80/æ™‚",
                "ä¸­å‹çŠ¬(5-10kg)ï¼š$90/æ™‚",
                "å¤§å‹çŠ¬(10kgä¸Š)ï¼š$100/æ™‚",
                "è²“å’ªï¼š$90/æ™‚"
            ].map((rate, i) => (
                <button key={i} 
                    onClick={() => setReportData({...reportData, overtime: rate})}
                    className={`text-[9px] font-bold py-2 px-1 rounded-lg border transition-all ${reportData.overtime === rate ? 'bg-soosi-wood text-white border-soosi-wood' : 'bg-gray-50 text-gray-500 border-gray-100 hover:bg-gray-100'}`}>
                    {rate}
                </button>
            ))}
        </div>
    </div>
)}
                                </div>
                            )}

                            {/* é è¦½å€å¡Š */}
                            <div className="bg-gray-100 p-4 rounded-xl text-xs text-gray-600 leading-relaxed font-mono whitespace-pre-wrap border border-dashed border-gray-300 relative">
                                <div className="absolute top-2 right-2 text-[9px] text-white bg-gray-400 px-2 py-0.5 rounded-full">LINE é è¦½</div>
                                {generateText()}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="p-4 border-t border-gray-100 bg-white rounded-b-[2rem] shrink-0">
                            <button onClick={handleCopy} className="w-full py-3 bg-soosi-green text-white rounded-xl font-black shadow-lg flex items-center justify-center gap-2 hover:bg-[#5a7a63] transition-all active:scale-95">
                                <Icon name="copy" size={18}/> 
                                {activeTab === 'daily' ? 'è¤‡è£½æ—¥è¨˜' : 'è¤‡è£½é€šçŸ¥'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
// --- ä¿®æ”¹å¯†ç¢¼ Modal (ç®¡ç†å“¡å°ˆç”¨åŠ å¼·ç‰ˆ) ---
        const ChangePasswordModal = ({ isOpen, onClose }) => {
            const [targetEmail, setTargetEmail] = useState(ADMIN_EMAIL); // é è¨­ä¿®æ”¹ç®¡ç†å“¡è‡ªå·±
            const [oldPwd, setOldPwd] = useState("");
            const [newPwd, setNewPwd] = useState("");
            const [confirmPwd, setConfirmPwd] = useState("");
            const [loading, setLoading] = useState(false);

            if (!isOpen) return null;

            const handleUpdate = async () => {
                if (newPwd !== confirmPwd) return alert("âŒ æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦");
                if (newPwd.length < 6) return alert("âŒ å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 ç¢¼");
                
                setLoading(true);
                try {
                    // 1. åŸ·è¡Œç’°å¢ƒæª¢æŸ¥èˆ‡ç™»å…¥é©—è­‰
                    // ç‚ºäº†ä¿®æ”¹å¯†ç¢¼ï¼Œå¿…é ˆä»¥ã€Œè©²ç›®æ¨™å¸³è™Ÿã€çš„èº«ä»½é€²è¡Œé©—è­‰
                    const { error: verifyError } = await supabase.auth.signInWithPassword({
                        email: targetEmail,
                        password: oldPwd
                    });
                    
                    if (verifyError) throw new Error(`${targetEmail === ADMIN_EMAIL ? 'æ‚¨çš„èˆŠå¯†ç¢¼' : 'å“¡å·¥çš„èˆŠå¯†ç¢¼'}è¼¸å…¥éŒ¯èª¤`);

                    // 2. æ›´æ–°è©²å¸³è™Ÿçš„å¯†ç¢¼
                    const { error: updateError } = await supabase.auth.updateUser({ password: newPwd });
                    if (updateError) throw updateError;

                    alert(`âœ… [${targetEmail === ADMIN_EMAIL ? 'ç®¡ç†å“¡' : 'å“¡å·¥'}] å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼`);
                    
                    // 3. å¦‚æœå‰›æ‰æ˜¯æ”¹å“¡å·¥å¯†ç¢¼ï¼Œç³»çµ±ç¾åœ¨æ˜¯å“¡å·¥èº«ä»½ï¼Œéœ€è‡ªå‹•åˆ‡æ›å›ç®¡ç†å“¡
                    if (targetEmail === STAFF_EMAIL) {
                        alert("æ­£åœ¨åˆ‡æ›å›ç®¡ç†å“¡æ¬Šé™...");
                        window.location.reload(); 
                    }

                    onClose();
                    setOldPwd(""); setNewPwd(""); setConfirmPwd("");
                } catch (err) {
                    alert("ä¿®æ”¹å¤±æ•—ï¼š" + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl animate-in zoom-in-95">
                        <h3 className="font-black text-xl text-center mb-1 text-soosi-dark flex items-center justify-center gap-2">
                            <Icon name="shield-check" className="text-soosi-green"/> å¯†ç¢¼ä¿®æ”¹
                        </h3>
                        <p className="text-[10px] text-gray-400 text-center mb-6 font-bold">ç®¡ç†å“¡å¯åœ¨æ­¤æ›´æ–°ç³»çµ±ç™»å…¥èªè­‰</p>
                        
                        {/* ä¿®æ”¹å°è±¡é¸æ“‡ */}
                        <div className="flex bg-gray-100 p-1.5 rounded-2xl mb-6">
                            <button onClick={() => setTargetEmail(ADMIN_EMAIL)} className={`flex-1 py-2 rounded-xl text-xs font-black transition-all ${targetEmail === ADMIN_EMAIL ? 'bg-white text-soosi-green shadow-sm' : 'text-gray-400'}`}>ç®¡ç†å“¡(è‡ªå·±)</button>
                            <button onClick={() => setTargetEmail(STAFF_EMAIL)} className={`flex-1 py-2 rounded-xl text-xs font-black transition-all ${targetEmail === STAFF_EMAIL ? 'bg-white text-soosi-wood shadow-sm' : 'text-gray-400'}`}>ä¸€èˆ¬å“¡å·¥</button>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="text-[10px] font-black text-gray-400 ml-2 mb-1 block">è«‹è¼¸å…¥è©²å¸³è™Ÿç›®å‰çš„ã€èˆŠå¯†ç¢¼ã€‘</label>
                                <input type="password" placeholder="èˆŠå¯†ç¢¼" value={oldPwd} onChange={e=>setOldPwd(e.target.value)} className="admin-input text-center text-lg tracking-widest py-3" />
                            </div>
                            <div className="border-t border-dashed border-gray-100 my-2"></div>
                            <div>
                                <label className="text-[10px] font-black text-gray-400 ml-2 mb-1 block">è¨­å®šã€æ–°å¯†ç¢¼ã€‘</label>
                                <input type="password" placeholder="æ–°å¯†ç¢¼" value={newPwd} onChange={e=>setNewPwd(e.target.value)} className="admin-input text-center text-lg tracking-widest py-3 mb-2" />
                                <input type="password" placeholder="ç¢ºèªæ–°å¯†ç¢¼" value={confirmPwd} onChange={e=>setConfirmPwd(e.target.value)} className="admin-input text-center text-lg tracking-widest py-3" />
                            </div>
                        </div>

                        <div className="flex gap-3 mt-8">
                            <button onClick={onClose} className="flex-1 py-3 bg-gray-50 rounded-2xl text-xs font-black text-gray-400 hover:bg-gray-100 transition-colors">å–æ¶ˆ</button>
                            <button onClick={handleUpdate} disabled={loading} className="flex-[1.5] py-3 bg-soosi-dark text-white rounded-2xl text-xs font-black shadow-lg active:scale-95 transition-all">
                                {loading ? "è™•ç†ä¸­..." : "ç¢ºèªä¿®æ”¹"}
                            </button>
                        </div>
                        
                        {targetEmail === STAFF_EMAIL && (
                            <p className="mt-4 text-[9px] text-soosi-red font-bold text-center leading-relaxed">
                                â€» ä¿®æ”¹å“¡å·¥å¯†ç¢¼éœ€çŸ¥é“å“¡å·¥çš„ã€Œç¾æœ‰å¯†ç¢¼ã€ã€‚<br/>å®Œæˆå¾Œç³»çµ±å°‡è‡ªå‹•é‡æ–°æ•´ç†ä»¥ç¢ºä¿æ¬Šé™æ­£ç¢ºã€‚
                            </p>
                        )}
                    </div>
                </div>
            );
        };
        // --- CRM: é¡§å®¢è©³ç´°æ­·ç¨‹ Modal ---
        const CustomerDetailModal = ({ customer, onClose, onSelectOrder }) => {
            if (!customer) return null;
            return (
                <div className="fixed inset-0 z-[150] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-[#F9F7F2] rounded-[2.5rem] w-full max-w-2xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden animate-in zoom-in-95">
                        <div className="bg-white p-6 flex justify-between items-center border-b">
                            <div className="flex items-center gap-4">
                                <div className="w-14 h-14 bg-soosi-green rounded-2xl flex items-center justify-center text-white text-xl font-black">{customer.name[0]}</div>
                                <div>
                                    <h3 className="text-xl font-black text-soosi-dark">{customer.name}</h3>
                                    <p className="text-sm font-bold text-gray-400">{customer.phone}</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full"><Icon name="x" size={24}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-6">
                            <div className="grid grid-cols-3 gap-4">
                                <div className="bg-white p-4 rounded-2xl text-center border">
                                    <div className="text-[10px] font-bold text-gray-400">ç¸½æ¶ˆè²»</div>
                                    <div className="text-lg font-black text-soosi-wood">${customer.totalSpent}</div>
                                </div>
                                <div className="bg-white p-4 rounded-2xl text-center border">
                                    <div className="text-[10px] font-bold text-gray-400">ä¾†è¨ªæ¬¡æ•¸</div>
                                    <div className="text-lg font-black text-soosi-green">{customer.visitCount}æ¬¡</div>
                                </div>
                                <div className="bg-white p-4 rounded-2xl text-center border">
                                    <div className="text-[10px] font-bold text-gray-400">æ¯›å­©æ•¸</div>
                                    <div className="text-lg font-black text-soosi-accent">{customer.pets.size}éš»</div>
                                </div>
                            </div>
                            <div className="space-y-3">
                                <h4 className="font-black text-soosi-dark flex items-center gap-2"><Icon name="history" size={18}/> æ­·å²æœå‹™ç´€éŒ„</h4>
                                {customer.history.map(order => (
                                    <div key={order.id} onClick={() => { onSelectOrder(order); onClose(); }} className="bg-white p-4 rounded-2xl hover:border-soosi-green border-2 border-transparent cursor-pointer transition-all flex justify-between items-center group">
                                        <div className="flex items-center gap-3">
                                            <div className={`p-2 rounded-lg ${order.service_type === 'grooming' ? 'bg-soosi-green/10 text-soosi-green' : 'bg-soosi-wood/10 text-soosi-wood'}`}>
                                                <Icon name={order.service_type === 'grooming' ? 'scissors' : 'home'} size={16}/>
                                            </div>
                                            <div>
                                                <div className="text-sm font-black">{order.booking_date || order.check_in_date}</div>
                                                <div className="text-[10px] text-gray-400 font-bold">{order.booking_pets?.map(p=>p.pet_name).join(', ')}</div>
                                            </div>
                                        </div>
                                        <div className="text-sm font-black text-soosi-dark">${order.total_price}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
// --- å‡ç´šç‰ˆæ—¥æ›†æª¢è¦–å…ƒä»¶ (æ”¯æ´é ç´„æ¢é¡¯ç¤º) ---
const CalendarView = ({ orders, onSelectOrder }) => {
            const today = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
            
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(today);

            const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();
            
            // ä¸‹æ‹‰æ¸…å–®ç”¨çš„ï¼šå–å¾—é¸å®šæ—¥æœŸçš„ç‹—ç‹—è©³ç´°åå–®
            const dailyDogs = useMemo(() => {
                return orders.filter(o => {
                    if (o.status === 'cancelled') return false;
                    const date = selectedDate;
                    if (o.service_type === 'grooming') {
                        return (o.booking_date || o.check_in_date) === date;
                    } else {
                        return date >= o.check_in_date && date <= o.check_out_date;
                    }
                });
            }, [orders, selectedDate]);

            // ğŸŒŸ æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ¤æ–·ç‰¹å®šæ—¥æœŸæœ‰å“ªäº›å¯µç‰© (ç”¨æ–¼æ—¥æ›†æ ¼å­å…§é¡¯ç¤º)
            const getPetsForDate = (dateStr) => {
                return orders.filter(o => {
                    if (o.status === 'cancelled') return false;
                    if (o.service_type === 'grooming') {
                        return (o.booking_date || o.check_in_date) === dateStr;
                    } else {
                        return dateStr >= o.check_in_date && dateStr <= o.check_out_date;
                    }
                });
            };

            return (
                <div className="space-y-4 animate-in fade-in">
                    {/* æœˆä»½é¸æ“‡å™¨èˆ‡å›ä»Šå¤©æŒ‰éˆ• */}
                    <div className="flex justify-between items-center bg-white p-4 rounded-3xl shadow-sm border border-gray-100">
                        <div className="flex items-center gap-2">
                            <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth() - 1)))} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><Icon name="chevron-left"/></button>
                            <h3 className="font-black text-lg">{currentMonth.getFullYear()}å¹´ {currentMonth.getMonth() + 1}æœˆ</h3>
                            <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth() + 1)))} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><Icon name="chevron-right"/></button>
                        </div>
                        <button onClick={() => { setCurrentMonth(new Date()); setSelectedDate(today); }} className="px-4 py-1.5 bg-soosi-dark text-white rounded-full text-xs font-black shadow-sm active:scale-95 transition-all">ä»Šå¤©</button>
                    </div>

                    {/* ğŸŒŸ å‡ç´šç‰ˆæ—¥æ›†ç¶²æ ¼ï¼šèª¿æ•´é«˜åº¦ä»¥å®¹ç´å¯µç‰©æ¢ */}
                    <div className="bg-white rounded-[2rem] border shadow-sm overflow-hidden">
                        <div className="grid grid-cols-7 bg-gray-50 border-b">
                            {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d} className="text-center text-[10px] font-black text-gray-400 py-3">{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7">
                            {[...Array(firstDayOfMonth)].map((_, i) => <div key={`empty-${i}`} className="border-b border-r border-gray-50 min-h-[100px]" />)}
                            {[...Array(daysInMonth)].map((_, i) => {
                                const d = i + 1;
                                const dateStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                const isSelected = dateStr === selectedDate;
                                const isToday = dateStr === today;
                                const petsInDay = getPetsForDate(dateStr);

                                return (
                                    <div key={d} onClick={() => setSelectedDate(dateStr)} 
                                        className={`min-h-[100px] border-b border-r border-gray-50 p-1 cursor-pointer transition-all hover:bg-soosi-green/5 ${isSelected ? 'bg-soosi-green/10 ring-2 ring-inset ring-soosi-green z-10' : ''}`}>
                                        <div className="flex justify-between items-start mb-1">
                                            <span className={`text-[11px] font-black w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-soosi-red text-white' : isSelected ? 'text-soosi-green' : 'text-gray-400'}`}>{d}</span>
                                        </div>
                                        
                                        {/* ğŸŒŸ å¯µç‰©æ¢æ¸…å–® (é™åˆ¶é¡¯ç¤ºå‰3ç­†ï¼Œå…¶é¤˜é¡¯ç¤º +æ›´å¤š) */}
                                        <div className="space-y-0.5 overflow-hidden">
                                            {petsInDay.slice(0, 3).map(o => (
<div key={o.id} className={`text-[9px] font-black px-1.5 py-0.5 rounded-sm truncate text-white shadow-sm ${o.service_type === 'grooming' ? 'bg-blue-400' : 'bg-orange-400'}`}>
                                                    {o.service_type === 'grooming' && o.booking_time && <span className="opacity-80">[{o.booking_time}] </span>}
                                                    {o.booking_pets?.map(p => p.pet_name).join(',')}
                                                </div>
                                            ))}
                                            {petsInDay.length > 3 && (
                                                <div className="text-[8px] text-gray-400 font-bold text-center mt-0.5">+{petsInDay.length - 3} æ›´å¤š</div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* ç•¶æ—¥è©³æƒ…æ¸…å–® (ç¶­æŒåŸæœ¬è¨­è¨ˆï¼Œæ–¹ä¾¿é»æ“Šçœ‹è©³ç´°è³‡è¨Š) */}
                    <div className="bg-[#F9F7F2] rounded-[2rem] p-6 border-2 border-dashed border-soosi-wood/20">
                        <div className="flex justify-between items-center mb-4">
                            <h4 className="font-black text-soosi-dark flex items-center gap-2">
                                <Icon name="calendar-check" className="text-soosi-wood"/> {selectedDate} è©³æƒ…åå–®
                            </h4>
                            <span className="bg-white border px-3 py-1 rounded-full text-[10px] font-black text-soosi-wood">{dailyDogs.length} éš»æ¯›å­©</span>
                        </div>
                        
                        <div className="space-y-3">
                            {dailyDogs.length > 0 ? dailyDogs.map(o => (
                                <div key={o.id} onClick={() => onSelectOrder(o)} className="bg-white p-4 rounded-2xl border border-gray-100 hover:border-soosi-green cursor-pointer transition-all flex justify-between items-center group shadow-sm">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-1.5 h-10 rounded-full ${o.service_type === 'grooming' ? 'bg-blue-400' : 'bg-orange-400'}`}></div>
                                        <div>
                                            <div className="font-black text-soosi-dark text-base">{o.booking_pets?.map(p => p.pet_name).join(', ')}</div>
<div className="text-[10px] text-gray-400 font-bold">{o.owner_name} Â· {o.service_type === 'grooming' ? `âœ‚ï¸ ç¾å®¹ (${o.booking_time})` : 'ğŸ  ä½å®¿/å®‰è¦ª'}</div>
                                        </div>
                                    </div>
                                    <Icon name="chevron-right" size={16} className="text-gray-300 group-hover:text-soosi-green transition-transform group-hover:translate-x-1" />
                                </div>
                            )) : (
                                <div className="py-12 text-center">
                                    <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-300"><Icon name="calendar-off" size={32}/></div>
                                    <p className="text-gray-400 font-bold text-sm">æ­¤æ—¥æœŸæš«ç„¡ä»»ä½•é ç´„ç´€éŒ„ ğŸƒ</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ä¸» Dashboard ---
// --- ä¸» Dashboard (å®Œæ•´ç‰ˆï¼šåŒ…å«å…¨èƒ½æ¨™ç±¤åµæ¸¬) ---
        const Dashboard = ({ user }) => {
            const [showPwdModal, setShowPwdModal] = useState(false);
const [activeTab, setActiveTab] = useState('grooming');
            const [busySlots, setBusySlots] = useState([]); // å­˜æ”¾å·²é—œé–‰æ™‚æ®µ
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            const fetchOrders = async () => {
                setLoading(true);
                let query = supabase
                    .from('bookings')
                    .select('*, booking_pets(*)')
                    .order('created_at', { ascending: false });
                
                // CRM æˆ– æ—¥æ›† æ¨¡å¼ä¸‹ä¸ç¯©é¸æœå‹™é¡å‹ï¼ŒæŠ“å–å…¨è³‡æ–™
                if (activeTab !== 'crm' && activeTab !== 'calendar') {
                    const filterTypes = activeTab === 'grooming' ? ['grooming'] : ['boarding', 'daycare'];
                    query = query.in('service_type', filterTypes);
                }
                
                const { data, error } = await query;
                if (!error) setOrders(data || []);
                setLoading(false);
            };

            const updateStatus = async (id, newStatus) => {
                const { error } = await supabase.from('bookings').update({ status: newStatus }).eq('id', id);
                if (!error) {
                    setOrders(prev => prev.map(o => o.id === id ? { ...o, status: newStatus } : o));
                    if (selectedOrder?.id === id) setSelectedOrder(prev => ({ ...prev, status: newStatus }));
                }
            };

            const updateNote = async (id, note) => {
                const { error } = await supabase.from('bookings').update({ admin_note: note }).eq('id', id);
                if (!error) {
                    setOrders(prev => prev.map(o => o.id === id ? { ...o, admin_note: note } : o));
                }
            };

            const deleteOrder = async (id) => {
                const { error } = await supabase.from('bookings').delete().eq('id', id);
                if (!error) {
                    setOrders(prev => prev.filter(o => o.id !== id));
                    setSelectedOrder(null);
                    alert("è¨‚å–®å·²åˆªé™¤");
                } else {
                    alert("åˆªé™¤å¤±æ•—");
                }
            };

            const updateFullOrder = async (updatedOrder) => {
                const { error: mainError } = await supabase.from('bookings').update({
                    owner_name: updatedOrder.owner_name,
                    phone: updatedOrder.phone,
                    email: updatedOrder.email,
                    total_price: updatedOrder.total_price,
                    raw_data: updatedOrder.raw_data 
                }).eq('id', updatedOrder.id);

                if (!mainError && updatedOrder.booking_pets) {
                    for (const pet of updatedOrder.booking_pets) {
                        await supabase.from('booking_pets').update({
                            pet_name: pet.pet_name,
                            breed: pet.breed,
sex: pet.sex,
                            age: pet.age,
                            weight: pet.weight,
                            is_walking: pet.isWalking
                        }).eq('id', pet.id);
                    }
                }

                if (!mainError) {
                    setOrders(prev => prev.map(o => o.id === updatedOrder.id ? updatedOrder : o));
                    setSelectedOrder(updatedOrder); 
                    alert("è³‡æ–™å·²æ›´æ–°ï¼");
                } else {
                    alert("æ›´æ–°å¤±æ•—ï¼š" + mainError.message);
                }
            };

const fetchBusySlots = async (date) => {
                const { data } = await supabase.from('busy_slots').select('time_slot').eq('date', date);
                setBusySlots(data?.map(d => d.time_slot) || []);
            };

            const toggleSlot = async (date, slot) => {
                if (busySlots.includes(slot)) {
                    await supabase.from('busy_slots').delete().eq('date', date).eq('time_slot', slot);
                    setBusySlots(prev => prev.filter(s => s !== slot));
                } else {
                    await supabase.from('busy_slots').insert({ date, time_slot: slot });
                    setBusySlots(prev => [...prev, slot]);
                }
            };

            useEffect(() => { 
                fetchOrders(); 
                if (activeTab === 'slots') fetchBusySlots(new Date().toLocaleDateString('en-CA'));
            }, [activeTab]);

            const filteredOrders = useMemo(() => {
                return orders.filter(o => 
                    o.owner_name?.includes(searchTerm) || 
                    o.phone?.includes(searchTerm) || 
                    o.booking_pets?.some(p => p.pet_name?.includes(searchTerm))
                );
            }, [orders, searchTerm]);

            // CRM é¡§å®¢åˆ†çµ„é‚è¼¯
            const customers = useMemo(() => {
                const groups = {};
                orders.forEach(order => {
                    const phone = order?.phone;
                    if (!phone) return;
                    
                    if (!groups[phone]) {
                        groups[phone] = { 
                            name: order.owner_name, phone, totalSpent: 0, visitCount: 0, 
                            pets: new Set(), history: [] 
                        };
                    }
                    groups[phone].totalSpent += (order.total_price || 0);
                    groups[phone].visitCount += 1;
                    
                    order.booking_pets?.forEach(p => {
                        const cleanName = p.pet_name?.trim();
                        if (cleanName) groups[phone].pets.add(cleanName);
                    });
                    groups[phone].history.push(order);
                });
                return Object.values(groups).sort((a, b) => b.visitCount - a.visitCount);
            }, [orders]);

            const [selectedCustomer, setSelectedCustomer] = useState(null); 

            return (
                <div className="min-h-screen pb-20">
                    <nav className="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-soosi-green/10 px-6 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-3">
                            <img src="nav.png" className="w-10 h-10 object-contain" />
                            <span className="font-black text-soosi-dark text-xl tracking-tight">Soosi Admin</span>
                        </div>
                        
                        <div className="flex items-center gap-2"><a href="https://resend.com/emails" target="_blank" className="w-10 h-10 bg-white border-2 border-gray-100 rounded-full flex items-center justify-center text-blue-500 hover:border-blue-500 hover:bg-blue-50 transition-all shadow-sm" title="å‰å¾€ Resend æŸ¥çœ‹é¡åº¦">
    <Icon name="mail" size={16}/>
</a>
                            {user?.email === ADMIN_EMAIL && (
                                <button onClick={() => setShowPwdModal(true)} className="w-10 h-10 bg-white border-2 border-gray-100 rounded-full flex items-center justify-center text-soosi-wood hover:border-soosi-wood hover:bg-soosi-wood hover:text-white transition-all shadow-sm" title="ç®¡ç†å“¡æ¬Šé™ï¼šä¿®æ”¹å¯†ç¢¼">
                                    <Icon name="key" size={16}/>
                                </button>
                            )}
                            <button onClick={() => supabase.auth.signOut()} className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-soosi-red transition-all" title="ç™»å‡º">
                                <Icon name="log-out" size={18}/>
                            </button>
                        </div>
                    </nav>

                    <main className="max-w-4xl mx-auto p-6 space-y-6">
                        <div className="relative group">
                            <Icon name="search" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 group-focus-within:text-soosi-green transition-colors" />
                            <input 
                                type="text" 
                                placeholder="æœå°‹ä¸»äººå§“åã€é›»è©±ã€æ¯›å­©åå­—..." 
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="w-full pl-12 pr-4 py-4 rounded-2xl bg-white shadow-sm border-2 border-transparent focus:border-soosi-green outline-none font-bold text-sm transition-all"
                            />
                        </div>

<div className="grid grid-cols-6 gap-2 bg-white p-2 rounded-[2rem] shadow-sm border border-gray-100">
    {/* å‰äºŒå€‹ä½” 3 æ ¼ (å¹³åˆ†ç¬¬ä¸€æ’) */}
    <button onClick={() => setActiveTab('grooming')} className={`col-span-3 py-3 rounded-2xl font-black text-sm flex items-center justify-center gap-2 transition-all ${activeTab === 'grooming' ? 'bg-soosi-green text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
        <Icon name="scissors" size={16}/> æ´—æ¾¡ç¾å®¹
    </button>
    <button onClick={() => setActiveTab('boarding')} className={`col-span-3 py-3 rounded-2xl font-black text-sm flex items-center justify-center gap-2 transition-all ${activeTab === 'boarding' ? 'bg-soosi-wood text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
        <Icon name="home" size={16}/> ä½å®¿å®‰è¦ª
    </button>
    
    {/* å¾Œä¸‰å€‹å„ä½” 2 æ ¼ (å¹³åˆ†ç¬¬äºŒæ’) */}
    <button onClick={() => setActiveTab('crm')} className={`col-span-2 py-3 rounded-2xl font-black text-[10px] flex flex-col items-center gap-1 transition-all ${activeTab === 'crm' ? 'bg-soosi-dark text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
        <Icon name="users" size={14}/> é¡§å®¢ç®¡ç†
    </button>
    <button onClick={() => setActiveTab('calendar')} className={`col-span-2 py-3 rounded-2xl font-black text-[10px] flex flex-col items-center gap-1 transition-all ${activeTab === 'calendar' ? 'bg-soosi-accent text-soosi-dark shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
        <Icon name="calendar" size={14}/> æ—¥æ›†æª¢è¦–
    </button>
    <button onClick={() => setActiveTab('slots')} className={`col-span-2 py-3 rounded-2xl font-black text-[10px] flex flex-col items-center gap-1 transition-all ${activeTab === 'slots' ? 'bg-red-500 text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
        <Icon name="clock" size={14}/> æ™‚æ®µè¨­å®š
    </button>
</div>

                        {loading ? (
                            <div className="py-20 text-center text-gray-400 font-black">è¼‰å…¥è³‡æ–™ä¸­...</div>
                        ) : activeTab === 'crm' ? (
                            // --- 1. CRM é¡§å®¢åˆ—è¡¨ ---
                            <div className="space-y-3">
                                {customers.map(c => (
                                    <div key={c.phone} onClick={() => setSelectedCustomer(c)} className="cute-card p-5 bg-white flex justify-between items-center cursor-pointer hover:border-soosi-green transition-all">
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 bg-soosi-green/10 text-soosi-green rounded-xl flex items-center justify-center font-black text-lg">{c.name[0]}</div>
                                            <div>
                                                <div className="font-black text-soosi-dark">{c.name}</div>
                                                <div className="text-[10px] text-gray-400 font-bold">
                                                    {c.phone} Â· {c.visitCount}æ¬¡ä¾†è¨ª Â· <span className="text-soosi-green">{c.pets.size} éš»æ¯›å­©</span>
                                                </div>
                                                <div className="text-[9px] text-gray-300 font-bold mt-0.5">
                                                    {[...c.pets].join(', ')}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-xs font-bold text-soosi-wood">ç¸½é¡ ${c.totalSpent}</div>
                                            <div className="text-[9px] text-gray-300 font-bold">æŸ¥çœ‹ç´€éŒ„ â†’</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
) : activeTab === 'calendar' ? (
                            // --- 2. æ—¥æ›†è¦–åœ– ---
                            <CalendarView orders={orders} onSelectOrder={setSelectedOrder} />
                        ) : activeTab === 'slots' ? (
                            // --- 4. æ™‚æ®µç®¡ç†ä»‹é¢ ---
                            <div className="bg-white p-6 rounded-[2rem] shadow-sm space-y-6 animate-in fade-in">
                                <div className="flex justify-between items-center border-b pb-4">
                                    <h3 className="font-black text-lg text-soosi-dark">ç¾å®¹é ç´„æ™‚æ®µé–‹é—œ</h3>
                                    <input type="date" className="admin-input w-40" defaultValue={new Date().toLocaleDateString('en-CA')} onChange={e => fetchBusySlots(e.target.value)} id="slot_date_picker" />
                                </div>
                                <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                    {Array.from({length: 21}, (_, i) => {
                                        const h = Math.floor(i/2) + 10;
                                        const m = i % 2 === 0 ? '00' : '30';
                                        const slot = `${h}:${m}`;
                                        const isBusy = busySlots.includes(slot);
                                        return (
                                            <button key={slot} 
                                                onClick={() => toggleSlot(document.getElementById('slot_date_picker').value, slot)}
                                                className={`py-3 rounded-xl text-xs font-bold border transition-all ${isBusy ? 'bg-red-100 text-red-500 border-red-200' : 'bg-green-50 text-green-600 border-green-100'}`}>
                                                {slot} {isBusy ? 'å·²é¡æ»¿' : 'å¯é ç´„'}
                                            </button>
                                        );
                                    })}
                                </div>
                                <p className="text-[10px] text-gray-400 font-bold text-center">â€» é»æ“ŠæŒ‰éˆ•å¯æ‰‹å‹•é—œé–‰è©²æ™‚æ®µï¼Œå‰å°é ç´„é é¢å°‡åŒæ­¥éš±è—è©²é¸é …ã€‚</p>
                            </div>
                        ) : (
                            // --- 3. ä¸€èˆ¬è¨‚å–®åˆ—è¡¨ (ç¾å®¹/ä½å®¿) - å·²åŒ…å«æ¨™ç±¤åµæ¸¬ ---
                            <div className="space-y-4">
                                {filteredOrders.map(order => {
                                    // ğŸŒŸ æ­¥é©Ÿ 1: è§£æåŸå§‹è³‡æ–™ (ç‚ºäº†ç›¸å®¹èˆŠè¨‚å–®)
                                    let rawProps = {};
                                    try {
                                        const parsed = typeof order.raw_data === 'string' ? JSON.parse(order.raw_data) : order.raw_data;
                                        rawProps = parsed?.raw_data || parsed || {};
                                    } catch (e) {}

                                    // ğŸŒŸ æ­¥é©Ÿ 2: å…¨èƒ½æ¨™ç±¤åµæ¸¬å‡½æ•¸ (åŒæ™‚æª¢æŸ¥ DB å’Œ Raw Data)
                                    const checkTag = (field, targetValue) => {
                                        // A. æŸ¥è³‡æ–™åº« (Booking Pets) - é‡å°æ–°è¨‚å–®æˆ–å·²æ›´æ–°çš„è¨‚å–®
                                        if (order.booking_pets?.some(p => p[field] === targetValue)) return true;
                                        // B. æŸ¥åŸå§‹è³‡æ–™ (Raw Data) - é‡å°èˆŠè¨‚å–®
                                        if (rawProps[field] === targetValue) return true;
                                        return false;
                                    };

                                    // åŸ·è¡Œåµæ¸¬
                                    const hasAggression = checkTag('social_aggression', 'æœ‰æ”»æ“Šæ€§');
                                    const isSensitive = checkTag('grooming_temperament', 'æ•æ„Ÿå¯¶å¯¶');
                                    const hasMedical = checkTag('medical_status', 'æœ‰');
                                    const imageAuthDisagree = rawProps.image_auth === 'disagree';

                                    return (
                                        <div key={order.id} onClick={() => setSelectedOrder(order)} className="cute-card p-6 bg-white cursor-pointer relative overflow-hidden group">
                                            <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${
                                                order.status === 'confirmed' ? 'bg-soosi-green' : 
                                                order.status === 'pending' ? 'bg-soosi-accent' : 
                                                order.status === 'cancelled' ? 'bg-soosi-red' : 'bg-gray-200'
                                            }`}></div>
                                            
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <div className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 flex items-center gap-2">
                                                        <span className="flex items-center gap-1">
                                                            <Icon name="calendar" size={12} className="mb-0.5"/>
{['boarding', 'daycare'].includes(order.service_type) 
                                                                ? `${order.check_in_date} ~ ${order.check_out_date?.slice(5)}` 
                                                                : `${order.booking_date || order.check_in_date || order.booking_time?.split('T')[0]} ${order.booking_time || ''}`}
                                                        </span>
                                                        {order.booking_pets?.length > 1 && 
                                                            <span className="bg-soosi-wood/10 text-soosi-wood px-1.5 py-0.5 rounded-full ml-1">
                                                                {order.booking_pets.length}éš»
                                                            </span>
                                                        }
                                                    </div>
                                                    
                                                    <div className="font-black text-2xl text-soosi-dark flex items-center gap-2">
                                                        {order.booking_pets?.map(p => p.pet_name).join(', ')}
                                                    </div>

                                                    {/* ğŸŒŸ è­¦ç¤ºæ¨™ç±¤åˆ— (ä¿è­‰é¡¯ç¤º) */}
                                                    {(hasAggression || isSensitive || hasMedical) && (
                                                        <div className="flex flex-wrap gap-1.5 mt-2 animate-in fade-in">
                                                            {hasAggression && (
                                                                <span className="inline-flex items-center gap-1 text-[10px] font-black bg-red-600 text-white px-2 py-0.5 rounded-md shadow-sm">
                                                                    <Icon name="alert-octagon" size={10} /> æœ‰æ”»æ“Šæ€§
                                                                </span>
                                                            )}
                                                            {isSensitive && (
                                                                <span className="inline-flex items-center gap-1 text-[10px] font-black bg-orange-100 text-orange-600 px-2 py-0.5 rounded-md border border-orange-200">
                                                                    <Icon name="zap" size={10} /> æ•æ„Ÿå¯¶å¯¶
                                                                </span>
                                                            )}
                                                            {hasMedical && (
                                                                <span className="inline-flex items-center gap-1 text-[10px] font-black bg-blue-100 text-blue-600 px-2 py-0.5 rounded-md border border-blue-200">
                                                                    <Icon name="activity" size={10} /> æœ‰ç—…å²
                                                                </span>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="text-right">
                                                    <div className="font-black text-lg text-soosi-wood">${order.total_price}</div>
                                                    <span className={`status-badge block mt-1 ${
                                                        order.status === 'pending' ? 'status-pending' :
                                                        order.status === 'confirmed' ? 'status-confirmed' :
                                                        order.status === 'cancelled' ? 'status-cancelled' : 'status-completed'
                                                    }`}>
                                                        {order.status === 'pending' ? 'å¾…ç¢ºèª' :
                                                            order.status === 'confirmed' ? 'å·²ç¢ºèª' :
                                                            order.status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'å·²å®Œæˆ'}
                                                    </span>
                                                </div>
                                            </div>

                                            <div className="flex items-center gap-4 text-xs font-bold text-gray-400 mt-3 border-t border-dashed border-gray-100 pt-3">
                                                <div className="flex items-center gap-1.5 text-soosi-green">
                                                    <Icon name="user" size={14}/>
                                                    {order.owner_name}
                                                </div>
                                                <div className="flex items-center gap-1.5">
                                                    <Icon name="phone" size={14}/>
                                                    {order.phone}
                                                </div>

                                                {/* å½±åƒæˆæ¬Šä¸åŒæ„æ¨™ç±¤ */}
                                                {imageAuthDisagree && (
                                                    <div className="ml-auto flex items-center gap-1 text-[10px] bg-red-50 text-red-500 px-2 py-1 rounded-full font-black border border-red-100">
                                                        <Icon name="camera-off" size={12}/> 
                                                        <span>æ‹’çµ•æ‹æ”</span>
                                                    </div>
                                                )}
                                            </div>

                                            {order.admin_note && (
                                                <div className="mt-3 pt-3 border-t border-dashed border-gray-200 text-xs text-soosi-wood/80 truncate">
                                                    <span className="font-bold">ğŸ“ å‚™è¨»ï¼š</span>{order.admin_note}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                                {filteredOrders.length === 0 && <div className="py-20 text-center text-gray-300 font-black">æš«ç„¡ç›¸é—œé ç´„è¨‚å–® ğŸƒ</div>}
                            </div>
                        )}
                    </main>

                    <OrderModal 
                        user={user}
                        order={selectedOrder} 
                        onClose={() => setSelectedOrder(null)} 
                        onUpdateStatus={updateStatus} 
                        onUpdateNote={updateNote}
                        onDeleteOrder={deleteOrder}
                        onUpdateFullOrder={updateFullOrder}
                    />
                    
                    <ChangePasswordModal isOpen={showPwdModal} onClose={() => setShowPwdModal(false)} />
                    <CustomerDetailModal customer={selectedCustomer} onClose={() => setSelectedCustomer(null)} onSelectOrder={setSelectedOrder} />
                </div>
            );
        };
// ğŸŒŸ æ–°å¢ï¼šæ›´æ–°é€šçŸ¥çµ„ä»¶ (ç½®é ‚é¿é–‹åŠ‰æµ·ç‰ˆ)
        const UpdatePrompt = ({ show, onUpdate }) => {
            if (!show) return null;
            return (
                <div className="fixed left-6 right-6 z-[400] md:left-1/2 md:-translate-x-1/2 md:w-auto md:min-w-[320px] top-[calc(env(safe-area-inset-top)+1.5rem)]">
                    <div className="bg-white p-4 rounded-2xl shadow-2xl border-2 border-soosi-green flex items-center justify-between gap-4 animate-in slide-in-from-top-4 duration-500">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-soosi-green text-white rounded-full flex items-center justify-center shrink-0 animate-spin">
                                <Icon name="refresh-cw" size={20} />
                            </div>
                            <div>
                                <h4 className="font-black text-soosi-dark text-sm">ç™¼ç¾æ–°ç‰ˆæœ¬ï¼</h4>
                                <p className="text-[10px] text-gray-400 font-bold">Admin ç³»çµ±å·²æ›´æ–° âœ¨</p>
                            </div>
                        </div>
                        <button 
                            onClick={onUpdate}
                            className="bg-soosi-green text-white text-xs font-black px-4 py-2.5 rounded-xl shadow-lg shadow-soosi-green/20 hover:bg-[#5a7a63] active:scale-95 transition-all whitespace-nowrap"
                        >
                            ç«‹å³æ›´æ–°
                        </button>
                    </div>
                </div>
            );
        };
const App = () => {
            const [session, setSession] = useState(null);
            // ğŸŒŸ æ–°å¢ï¼šæ›´æ–°æç¤ºç‹€æ…‹
            const [showUpdate, setShowUpdate] = useState(false);

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => setSession(session));
                supabase.auth.onAuthStateChange((_event, session) => setSession(session));
            }, []);

            // ğŸŒŸ æ–°å¢ï¼šService Worker ç›£è½é‚è¼¯ (Admin ç‰ˆ)
            useEffect(() => {
                if ('serviceWorker' in navigator) {
                    const registerSW = async () => {
                        try {
                            // è¨»å†Š Admin SW (é€™è£¡ç‰ˆæœ¬è™Ÿ v=16 è¨˜å¾—è·Ÿ sw-admin.js é…åˆæ›´æ–°)
                            const registration = await navigator.serviceWorker.register('./sw-admin.js?v=16');
                            
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    // ç•¶æ–°ç‰ˆæœ¬å®‰è£å®Œæˆ (installed) ä¸”ç›®å‰å·²ç¶“æœ‰æ§åˆ¶æ¬Š (controller) ä»£è¡¨æ˜¯æ›´æ–°
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        setShowUpdate(true);
                                    }
                                });
                            });
                        } catch (error) {
                            console.error('Admin SW è¨»å†Šå¤±æ•—:', error);
                        }
                    };
                    registerSW();
                }
            }, []);

            return (
                <>
                    {/* é¡¯ç¤ºæ›´æ–°æç¤º */}
                    <UpdatePrompt show={showUpdate} onUpdate={() => window.location.reload()} />
                    {session ? <Dashboard user={session.user} /> : <LoginView onLogin={() => {}} />}
                </>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>